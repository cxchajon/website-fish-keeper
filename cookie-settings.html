<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cookie Settings — The Tank Guide</title>
  <meta name="description" content="Manage your cookie preferences for The Tank Guide. Update consent for analytics and advertising cookies anytime." />
  <link rel="icon" href="/favicon.ico" />
  <link rel="canonical" href="https://thetankguide.com/cookie-settings.html" />
  <link rel="stylesheet" href="/css/style.css?v=1.0.9" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script defer src="/js/nav.js?v=1.1.0"></script>
  <style>
    body.theme-light { background: radial-gradient(circle at top, rgba(15,51,82,.9), rgba(7,18,32,1)); color: #fff; }
    main.cookie-settings { max-width: 720px; margin: 0 auto; padding: 72px 20px 96px; text-align: left; }
    .cookie-settings h1 { margin: 0 0 12px; font-size: clamp(32px, 4vw, 44px); }
    .cookie-settings p { margin: 0 0 16px; line-height: 1.6; color: rgba(255,255,255,.88); }
    .cookie-actions { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 24px; }
    .cookie-actions button { border-radius: 12px; border: 1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.08); color: #fff; padding: 12px 18px; font-weight: 600; cursor: pointer; }
    .cookie-actions button:hover { background: rgba(255,255,255,.16); }
  </style>
  <!-- Consent Mode defaults (load FIRST) -->
  <script src="/assets/js/consent-mode.js" defer></script>

  <!-- AdSense loader (keep one global instance only) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9905718149811880"
    crossorigin="anonymous"></script>
  <!-- --- Google CMP (Funding Choices) START --- -->
  <script async src="https://fundingchoicesmessages.google.com/i/pub-9905718149811880?ers=1"></script>
  <script>
    // Required bootstrap per Google; signals CMP presence
    (function() {
      function signalGooglefcPresent() {
        if (!window.frames['googlefcPresent']) {
          if (document.body) {
            const iframe = document.createElement('iframe');
            iframe.style.cssText = 'display:none';
            iframe.name = 'googlefcPresent';
            document.body.appendChild(iframe);
          } else {
            setTimeout(signalGooglefcPresent, 0);
          }
        }
      }
      signalGooglefcPresent();
    })();
  </script>
  <!-- --- Google CMP (Funding Choices) END --- -->
</head>
<body class="theme-light">
  <div id="site-nav"></div>
  <main class="cookie-settings" aria-labelledby="cookie-settings-title">
    <h1 id="cookie-settings-title">Cookie Settings</h1>
    <p>You can review and change your cookie consent choices for The Tank Guide at any time. Use the buttons below to reopen the cookie preferences banner or reset your saved selections.</p>
    <p>Essential cookies are required to run the site. Analytics and advertising cookies are optional and will only load if you grant consent.</p>
    <div class="cookie-actions">
      <button type="button" id="cookie-open-modal">Manage preferences</button>
      <button type="button" id="cookie-reset">Reset consent</button>
    </div>
  </main>

  <div id="site-footer"></div>
  <script>
(async () => {
  try {
    const res = await fetch('/footer.v1.3.0.html?v=1.3.0', { cache: 'no-cache' });
    const html = await res.text();
    const host = document.getElementById('site-footer');
    if (host) host.outerHTML = html;
  } catch (e) { console.error('[Footer] load failed:', e); }
})();
  </script>

<!-- === TTG Cookie Consent START === -->
<div id="ttg-consent" class="ttg-consent" hidden>
  <div class="ttg-consent__inner" role="dialog" aria-labelledby="ttg-consent-title" aria-describedby="ttg-consent-desc">
    <h3 id="ttg-consent-title">Cookies & Advertising</h3>
    <p id="ttg-consent-desc">
      We use cookies to run this site and (if you allow) to show relevant ads from Google AdSense. You can accept all cookies, reject personalized ads, or manage preferences anytime.
    </p>
    <div class="ttg-consent__actions">
      <button type="button" class="ttg-btn ttg-btn--secondary js-consent-reject" id="ttg-consent-reject">Reject (Non-personalized)</button>
      <button type="button" class="ttg-btn ttg-btn--ghost" id="ttg-consent-manage">Manage</button>
      <button type="button" class="ttg-btn ttg-btn--primary js-consent-accept" id="ttg-consent-accept">Accept All</button>
    </div>
  </div>
</div>

<div id="ttg-consent-modal" class="ttg-consent-modal" hidden aria-modal="true" role="dialog" aria-labelledby="ttg-consent-modal-title">
  <div class="ttg-consent-modal__panel">
    <h3 id="ttg-consent-modal-title">Cookie Preferences</h3>
    <form id="ttg-consent-form">
      <label class="ttg-row">
        <input type="checkbox" checked disabled />
        <span><strong>Essential</strong> — required for core site functions.</span>
      </label>
      <label class="ttg-row">
        <input type="checkbox" id="ttg-c-analytics" />
        <span><strong>Analytics</strong> — understand usage (if enabled later).</span>
      </label>
      <label class="ttg-row">
        <input type="checkbox" id="ttg-c-ads" />
        <span><strong>Advertising</strong> — allow personalized ads (Google AdSense).</span>
      </label>
      <div class="ttg-consent-modal__actions">
        <button type="button" class="ttg-btn ttg-btn--ghost" id="ttg-consent-cancel">Cancel</button>
        <button type="submit" class="ttg-btn ttg-btn--primary">Save</button>
      </div>
      <p class="ttg-consent-status" hidden></p>
    </form>
  </div>
</div>

<style>
  .ttg-consent { position: fixed; inset: auto 16px 16px; z-index: 9999; max-width: 380px; background: rgba(8, 20, 36, 0.94); color: #fff; border-radius: 16px; box-shadow: 0 24px 60px rgba(0, 0, 0, 0.35); padding: 20px; display: grid; gap: 14px; }
  .ttg-consent[hidden] { display: none !important; }
  .ttg-consent h3 { margin: 0; font-size: 18px; }
  .ttg-consent p { margin: 0; font-size: 14px; line-height: 1.5; opacity: 0.9; }
  .ttg-consent__actions { display: grid; gap: 10px; }
  .ttg-btn { border-radius: 12px; padding: 12px 16px; font-weight: 600; cursor: pointer; }
  .ttg-btn--primary { background: #1e90ff; color: #fff; border: none; }
  .ttg-btn--secondary { background: rgba(255,255,255,0.1); color: #fff; border: none; }
  .ttg-btn--ghost { background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.22); }
  .ttg-consent-modal { position: fixed; inset: 0; display: grid; place-items: center; background: rgba(5, 12, 22, 0.8); z-index: 10000; }
  .ttg-consent-modal[hidden] { display: none !important; }
  .ttg-consent-modal__panel { background: #081426; color: #fff; border-radius: 18px; padding: 28px; width: min(480px, 92%); display: grid; gap: 18px; }
  .ttg-consent-modal__panel h3 { margin: 0; font-size: 20px; }
  .ttg-consent-modal__panel form { display: grid; gap: 14px; }
  .ttg-row { display: flex; gap: 12px; align-items: flex-start; font-size: 14px; }
  .ttg-row input { margin-top: 3px; }
  .ttg-consent-modal__actions { display: flex; gap: 12px; justify-content: flex-end; }
  .ttg-consent-status { margin: 0; font-size: 13px; opacity: 0.8; }
  @media (max-width: 540px) {
    .ttg-consent { inset: auto 12px 12px; padding: 18px; }
    .ttg-consent-modal__panel { padding: 24px; }
  }
</style>

<script>
(() => {
  const KEY = 'ttg.consent.v1';

  const $banner = document.getElementById('ttg-consent');
  const $modal  = document.getElementById('ttg-consent-modal');
  const $btnAccept = document.getElementById('ttg-consent-accept');
  const $btnReject = document.getElementById('ttg-consent-reject');
  const $btnManage = document.getElementById('ttg-consent-manage');
  const $btnCancel = document.getElementById('ttg-consent-cancel');
  const $form = document.getElementById('ttg-consent-form');

  const $rows        = $form ? $form.querySelectorAll('.ttg-row') : [];
  const $ckEssential = $rows[0] ? $rows[0].querySelector('input[type="checkbox"]') : null;
  const $ckAnalytics = document.getElementById('ttg-c-analytics');
  const $ckAds       = document.getElementById('ttg-c-ads');

  let $status = $form ? $form.querySelector('.ttg-consent-status') : null;
  if ($form && !$status){
    $status = document.createElement('p');
    $status.className = 'ttg-consent-status';
    $form.appendChild($status);
  }

  function updateStatus(){
    if(!$status) return;
    const a = $ckAnalytics && $ckAnalytics.checked ? 'ON' : 'OFF';
    const d = $ckAds && $ckAds.checked ? 'ON' : 'OFF';
    $status.textContent = `Current: Analytics ${a} • Advertising ${d}`;
  }

  function save(state){
    localStorage.setItem(KEY, JSON.stringify(state));
    document.documentElement.setAttribute('data-ad-consent', state.ads ? 'granted' : 'denied');
    window.dispatchEvent(new CustomEvent('ttg:consent-change'));
  }
  function load(){
    try { return JSON.parse(localStorage.getItem(KEY) || ''); } catch(e){ return null; }
  }
  function openBanner(){ if (typeof window.__tcfapi === 'function') { return; } if ($banner) $banner.hidden = false; }
  function closeBanner(){ if ($banner) $banner.hidden = true; }
  function openModal(){
    if(!$modal) return;
    $modal.hidden = false;

    if ($ckEssential){
      $ckEssential.checked = true;
      $ckEssential.disabled = true;
    }

    const s = load() || {analytics:false, ads:false};
    if ($ckAnalytics) $ckAnalytics.checked = !!s.analytics;
    if ($ckAds)       $ckAds.checked = !!s.ads;
    updateStatus();
  }
  function closeModal(){ if($modal) $modal.hidden = true; }

  closeModal();

  const state = load();
  if (!state){
    openBanner();
  } else {
    document.documentElement.setAttribute('data-ad-consent', state.ads ? 'granted' : 'denied');
  }

  if ($btnAccept){
    $btnAccept.addEventListener('click', () => {
      save({ analytics: true, ads: true });
      closeModal();
      closeBanner();
    });
  }
  if ($btnReject){
    $btnReject.addEventListener('click', () => {
      save({ analytics: false, ads: false });
      closeModal();
      closeBanner();
    });
  }
  if ($btnManage){
    $btnManage.addEventListener('click', () => {
      closeBanner();
      openModal();
    });
  }
  if ($btnCancel){
    $btnCancel.addEventListener('click', () => {
      closeModal();
    });
  }
  if ($form){
    $form.addEventListener('submit', (event) => {
      event.preventDefault();
      save({
        analytics: $ckAnalytics ? !!$ckAnalytics.checked : false,
        ads: $ckAds ? !!$ckAds.checked : false,
      });
      closeModal();
    });
  }
  if ($modal){
    $modal.addEventListener('click', (event) => {
      if (event.target === $modal){
        closeModal();
      }
    });
  }
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape' && $modal && !$modal.hidden) closeModal();
  });

  if (document.documentElement.getAttribute('data-ad-consent') !== 'granted'){
    window.__TTG_ADS_DISABLED__ = true;
  }

  window.cookieConsent = {
    open: function(){ openModal(); },
    reset: function(){ localStorage.removeItem(KEY); closeModal(); openBanner(); }
  };
})();
</script>
<!-- === TTG Consent → Ad Visibility Controller START === -->
<script>
(function(){
  var KEY = 'ttg.consent.v1';

  function hasGranted(){
    try {
      var s = JSON.parse(localStorage.getItem(KEY) || '');
      return !!(s && s.ads === true);
    } catch(e){ return false; }
  }

  function applyConsentToDOM(){
    var granted = hasGranted();
    document.documentElement.setAttribute('data-ad-consent', granted ? 'granted' : 'denied');
    document.documentElement.classList.toggle('is-ads-disabled', !granted);

    // If we’re only showing placeholders (no AdSense yet),
    // simply un-hide or keep hidden via the CSS above.
    // (When you later enable the AdSense loader, mount units here if granted.)
  }

  // Run now
  applyConsentToDOM();

  // Listen for same-page consent changes (buttons & form), then update immediately
  ['ttg-consent-accept','ttg-consent-reject'].forEach(function(id){
    var el = document.getElementById(id);
    if (el) el.addEventListener('click', function(){ setTimeout(applyConsentToDOM, 0); });
  });
  var form = document.getElementById('ttg-consent-form');
  if (form) form.addEventListener('submit', function(){ setTimeout(applyConsentToDOM, 0); });

  // If your cookie script dispatches a custom event, react to it too
  window.addEventListener('ttg:consent-change', applyConsentToDOM);

  // Cross-tab changes (Storage event)
  window.addEventListener('storage', function(e){
    if (e.key === KEY) applyConsentToDOM();
  });
})();
</script>
<!-- === TTG Consent → Ad Visibility Controller END === -->
<!-- === TTG CMP Consent Bridge START === -->
<script>
(function(){
  // Helper: map TCF consent to our single "ads granted" flag.
  // We consider "granted" only when Purpose 1 (storage) AND Purpose 4 (select personalised ads)
  // are consented. If you want to allow NON-personalised ads when only Purpose 1 is granted,
  // set allowNPA=true below.
  var allowNPA = true; // if true, we’ll treat Purpose 1 only as "granted" for showing slots (Google will serve NPA ads).

  function setAdConsent(granted){
    document.documentElement.setAttribute('data-ad-consent', granted ? 'granted' : 'denied');
    document.documentElement.classList.toggle('is-ads-disabled', !granted);
    // Inform any listeners (our ad loader later)
    window.dispatchEvent(new CustomEvent('ttg:consent-change', {detail:{granted}}));
  }

  // If Google CMP is present, it defines __tcfapi.
  function hookTCF(){
    if (typeof window.__tcfapi !== 'function') return false;

    // Hide our local cookie banner when Google CMP is running (EEA users).
    try{
      var banner = document.getElementById('ttg-consent');
      var modal  = document.getElementById('ttg-consent-modal');
      if (banner) banner.hidden = true;
      if (modal)  modal.hidden  = true;
    }catch(e){}

    // Listen for consent changes
    window.__tcfapi('addEventListener', 2, function(tcData, ok){
      if(!ok || !tcData) return;
      // Purpose 1 = storage; Purpose 4 = personalised ads
      var p = (tcData.purpose && tcData.purpose.consents) || {};
      var hasP1 = !!p[1];
      var hasP4 = !!p[4];

      var granted = allowNPA ? hasP1 : (hasP1 && hasP4);
      setAdConsent(granted);
    });

    // Also fetch current state once
    window.__tcfapi('getTCData', 2, function(tcData, ok){
      if(!ok || !tcData) return;
      var p = (tcData.purpose && tcData.purpose.consents) || {};
      var hasP1 = !!p[1];
      var hasP4 = !!p[4];
      var granted = allowNPA ? hasP1 : (hasP1 && hasP4);
      setAdConsent(granted);
    });

    return true;
  }

  // Try to hook immediately; if CMP loads a bit later, poll briefly
  if (!hookTCF()){
    var tries = 0, t = setInterval(function(){
      tries++;
      if (hookTCF() || tries > 40) clearInterval(t); // up to ~4s
    }, 100);
  }

  // Fallback for non-EEA visitors (no __tcfapi): keep using our local preference
  // Our existing local banner writes ttg.consent.v1 with {ads:true|false}.
  // If CMP absent, keep existing behavior (do not force-show anything here).

})();
</script>
<!-- === TTG CMP Consent Bridge END === -->

<!-- === TTG Cookie Consent END === -->

<script>
  document.getElementById('cookie-open-modal')?.addEventListener('click', () => {
    window.cookieConsent && window.cookieConsent.open();
  });
  document.getElementById('cookie-reset')?.addEventListener('click', () => {
    window.cookieConsent && window.cookieConsent.reset();
  });
  window.addEventListener('load', () => {
    if (window.cookieConsent && localStorage.getItem('ttg.consent.v1')) {
      window.cookieConsent.open();
    }
  });
</script>
</body>
</html>
