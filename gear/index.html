<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gear Guide | The Tank Guide</title>
  <link rel="stylesheet" href="/css/style.css?v=1.0.9" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/src/styles/gear.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="/favicon.ico" />
  <script defer src="/js/nav.js?v=1.1.0"></script>
  <!-- Consent Mode defaults (load FIRST) -->
  <script src="/assets/js/consent-mode.js" defer></script>

  <!-- AdSense loader (keep one global instance only) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9905718149811880"
    crossorigin="anonymous"></script>
  <!-- --- Google CMP (Funding Choices) START --- -->
  <script async src="https://fundingchoicesmessages.google.com/i/pub-9905718149811880?ers=1"></script>
  <script>
    // Required bootstrap per Google; signals CMP presence
    (function() {
      function signalGooglefcPresent() {
        if (!window.frames['googlefcPresent']) {
          if (document.body) {
            const iframe = document.createElement('iframe');
            iframe.style.cssText = 'display:none';
            iframe.name = 'googlefcPresent';
            document.body.appendChild(iframe);
          } else {
            setTimeout(signalGooglefcPresent, 0);
          }
        }
      }
      signalGooglefcPresent();
    })();
  </script>
  <!-- --- Google CMP (Funding Choices) END --- -->
</head>
<body class="theme-light">
  <!-- GLOBAL NAV -->
  <div id="site-nav"></div>
  <main id="gear-main">
    <div id="gear-root" data-testid="gear-root"></div>
    <!-- === TTG_GearBottom (before footer) === -->
    <div class="ttg-adunit ttg-adunit--bottom" id="ad-bottom-gear" aria-label="Advertisement">
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-9905718149811880"
           data-ad-slot="1762971638"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
      <script>
           (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  </main>
  <script type="module" src="/src/pages/GearPage.js"></script>
<!-- === TTG Cookie Consent START === -->
<div id="ttg-consent" class="ttg-consent" hidden>
  <div class="ttg-consent__inner" role="dialog" aria-labelledby="ttg-consent-title" aria-describedby="ttg-consent-desc">
    <h3 id="ttg-consent-title">Cookies & Advertising</h3>
    <p id="ttg-consent-desc">
      We use cookies to run this site and (if you allow) to show relevant ads from Google AdSense. You can accept all cookies, reject personalized ads, or manage preferences anytime.
    </p>
    <div class="ttg-consent__actions">
      <button type="button" class="ttg-btn ttg-btn--secondary js-consent-reject" id="ttg-consent-reject">Reject (Non-personalized)</button>
      <button type="button" class="ttg-btn ttg-btn--ghost" id="ttg-consent-manage">Manage</button>
      <button type="button" class="ttg-btn ttg-btn--primary js-consent-accept" id="ttg-consent-accept">Accept All</button>
    </div>
  </div>
</div>

<div id="ttg-consent-modal" class="ttg-consent-modal" hidden aria-modal="true" role="dialog" aria-labelledby="ttg-consent-modal-title">
  <div class="ttg-consent-modal__panel">
    <h3 id="ttg-consent-modal-title">Cookie Preferences</h3>
    <form id="ttg-consent-form">
      <label class="ttg-row">
        <input type="checkbox" checked disabled />
        <span><strong>Essential</strong> — required for core site functions.</span>
      </label>
      <label class="ttg-row">
        <input type="checkbox" id="ttg-c-analytics" />
        <span><strong>Analytics</strong> — understand usage (if enabled later).</span>
      </label>
      <label class="ttg-row">
        <input type="checkbox" id="ttg-c-ads" />
        <span><strong>Advertising</strong> — allow personalized ads (Google AdSense).</span>
      </label>
      <div class="ttg-consent-modal__actions">
        <button type="button" class="ttg-btn ttg-btn--ghost" id="ttg-consent-cancel">Cancel</button>
        <button type="submit" class="ttg-btn ttg-btn--primary">Save Preferences</button>
      </div>
    </form>
  </div>
</div>

<!-- === TTG Cookie Consent SCRIPT (checkbox fix + status) START === -->
<script>
(function(){
  const KEY = 'ttg.consent.v1';

  const $banner = document.getElementById('ttg-consent');
  const $modal  = document.getElementById('ttg-consent-modal');
  const $btnAccept = document.getElementById('ttg-consent-accept');
  const $btnReject = document.getElementById('ttg-consent-reject');
  const $btnManage = document.getElementById('ttg-consent-manage');
  const $btnCancel = document.getElementById('ttg-consent-cancel');
  const $form = document.getElementById('ttg-consent-form');

  // Checkboxes
  const $rows        = $form ? $form.querySelectorAll('.ttg-row') : [];
  const $ckEssential = $rows[0] ? $rows[0].querySelector('input[type="checkbox"]') : null;
  const $ckAnalytics = document.getElementById('ttg-c-analytics');
  const $ckAds       = document.getElementById('ttg-c-ads');

  // Add a small status line so you can verify state visually
  let $status = $form ? $form.querySelector('.ttg-consent-status') : null;
  if ($form && !$status){
    $status = document.createElement('p');
    $status.className = 'ttg-consent-status';
    $form.appendChild($status);
  }

  function updateStatus(){
    if(!$status) return;
    const a = $ckAnalytics && $ckAnalytics.checked ? 'ON' : 'OFF';
    const d = $ckAds && $ckAds.checked ? 'ON' : 'OFF';
    $status.textContent = `Current: Analytics ${a} • Advertising ${d}`;
  }

  function save(state){
    localStorage.setItem(KEY, JSON.stringify(state));
    document.documentElement.setAttribute('data-ad-consent', state.ads ? 'granted' : 'denied');
    window.dispatchEvent(new CustomEvent('ttg:consent-change'));
  }
  function load(){
    try { return JSON.parse(localStorage.getItem(KEY) || ''); } catch(e){ return null; }
  }
  function openBanner(){ if (typeof window.__tcfapi === 'function') { return; } if ($banner) $banner.hidden = false; }
  function closeBanner(){ if ($banner) $banner.hidden = true; }
  function openModal(){
    if(!$modal) return;
    $modal.hidden = false;

    // Essential MUST be checked & disabled
    if ($ckEssential){
      $ckEssential.checked = true;
      $ckEssential.disabled = true;
    }

    const s = load() || {analytics:false, ads:false};
    if ($ckAnalytics) $ckAnalytics.checked = !!s.analytics;
    if ($ckAds)       $ckAds.checked = !!s.ads;
    updateStatus();
  }
  function closeModal(){ if($modal) $modal.hidden = true; }

  // Ensure modal hidden initially
  closeModal();

  const state = load();
  if (!state){
    // First visit: banner only
    openBanner();
  } else {
    save(state);
    closeBanner(); closeModal();
  }

  // Wire up clicks on the whole row to toggle the checkbox (except Essential)
  $rows.forEach(function(row, idx){
    row.addEventListener('click', function(e){
      const cb = row.querySelector('input[type="checkbox"]');
      if (!cb) return;
      if (idx === 0) return; // Essential: no toggle
      if (e.target.tagName.toLowerCase() !== 'input'){
        cb.checked = !cb.checked;
        updateStatus();
      }
    });
  });
  if ($ckAnalytics) $ckAnalytics.addEventListener('change', updateStatus);
  if ($ckAds)       $ckAds.addEventListener('change', updateStatus);

  // Buttons
  if ($btnAccept) $btnAccept.addEventListener('click', function(){
    save({ essential:true, analytics:true, ads:true, ts:Date.now() });
    closeModal(); closeBanner();
  });
  if ($btnReject) $btnReject.addEventListener('click', function(){
    save({ essential:true, analytics:false, ads:false, ts:Date.now() });
    closeModal(); closeBanner();
  });
  if ($btnManage) $btnManage.addEventListener('click', openModal);
  if ($btnCancel) $btnCancel.addEventListener('click', closeModal);

  if ($form) $form.addEventListener('submit', function(e){
    e.preventDefault();
    save({
      essential: true,
      analytics: $ckAnalytics ? !!$ckAnalytics.checked : false,
      ads:       $ckAds ? !!$ckAds.checked : false,
      ts: Date.now()
    });
    closeModal(); closeBanner();
  });

  // Close modal on outside click
  if ($modal) $modal.addEventListener('click', function(e){
    if (e.target === $modal) closeModal();
  });

  // Close on Escape
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape' && $modal && !$modal.hidden) closeModal();
  });

  // Guard for ad scripts
  if (document.documentElement.getAttribute('data-ad-consent') !== 'granted'){
    window.__TTG_ADS_DISABLED__ = true;
  }

  // Public API for footer link
  window.cookieConsent = {
    open: function(){ openModal(); },
    reset: function(){ localStorage.removeItem(KEY); closeModal(); openBanner(); }
  };
})();
</script>
<!-- === TTG Cookie Consent SCRIPT (checkbox fix + status) END === -->

<!-- === TTG Consent → Ad Visibility Controller START === -->
<script>
(function(){
  var KEY = 'ttg.consent.v1';

  function hasGranted(){
    try {
      var s = JSON.parse(localStorage.getItem(KEY) || '');
      return !!(s && s.ads === true);
    } catch(e){ return false; }
  }

  function applyConsentToDOM(){
    var granted = hasGranted();
    document.documentElement.setAttribute('data-ad-consent', granted ? 'granted' : 'denied');
    document.documentElement.classList.toggle('is-ads-disabled', !granted);

    // If we’re only showing placeholders (no AdSense yet),
    // simply un-hide or keep hidden via the CSS above.
    // (When you later enable the AdSense loader, mount units here if granted.)
  }

  // Run now
  applyConsentToDOM();

  // Listen for same-page consent changes (buttons & form), then update immediately
  ['ttg-consent-accept','ttg-consent-reject'].forEach(function(id){
    var el = document.getElementById(id);
    if (el) el.addEventListener('click', function(){ setTimeout(applyConsentToDOM, 0); });
  });
  var form = document.getElementById('ttg-consent-form');
  if (form) form.addEventListener('submit', function(){ setTimeout(applyConsentToDOM, 0); });

  // If your cookie script dispatches a custom event, react to it too
  window.addEventListener('ttg:consent-change', applyConsentToDOM);

  // Cross-tab changes (Storage event)
  window.addEventListener('storage', function(e){
    if (e.key === KEY) applyConsentToDOM();
  });
})();
</script>
<!-- === TTG Consent → Ad Visibility Controller END === -->
<!-- === TTG CMP Consent Bridge START === -->
<script>
(function(){
  // Helper: map TCF consent to our single "ads granted" flag.
  // We consider "granted" only when Purpose 1 (storage) AND Purpose 4 (select personalised ads)
  // are consented. If you want to allow NON-personalised ads when only Purpose 1 is granted,
  // set allowNPA=true below.
  var allowNPA = true; // if true, we’ll treat Purpose 1 only as "granted" for showing slots (Google will serve NPA ads).

  function setAdConsent(granted){
    document.documentElement.setAttribute('data-ad-consent', granted ? 'granted' : 'denied');
    document.documentElement.classList.toggle('is-ads-disabled', !granted);
    // Inform any listeners (our ad loader later)
    window.dispatchEvent(new CustomEvent('ttg:consent-change', {detail:{granted}}));
  }

  // If Google CMP is present, it defines __tcfapi.
  function hookTCF(){
    if (typeof window.__tcfapi !== 'function') return false;

    // Hide our local cookie banner when Google CMP is running (EEA users).
    try{
      var banner = document.getElementById('ttg-consent');
      var modal  = document.getElementById('ttg-consent-modal');
      if (banner) banner.hidden = true;
      if (modal)  modal.hidden  = true;
    }catch(e){}

    // Listen for consent changes
    window.__tcfapi('addEventListener', 2, function(tcData, ok){
      if(!ok || !tcData) return;
      // Purpose 1 = storage; Purpose 4 = personalised ads
      var p = (tcData.purpose && tcData.purpose.consents) || {};
      var hasP1 = !!p[1];
      var hasP4 = !!p[4];

      var granted = allowNPA ? hasP1 : (hasP1 && hasP4);
      setAdConsent(granted);
    });

    // Also fetch current state once
    window.__tcfapi('getTCData', 2, function(tcData, ok){
      if(!ok || !tcData) return;
      var p = (tcData.purpose && tcData.purpose.consents) || {};
      var hasP1 = !!p[1];
      var hasP4 = !!p[4];
      var granted = allowNPA ? hasP1 : (hasP1 && hasP4);
      setAdConsent(granted);
    });

    return true;
  }

  // Try to hook immediately; if CMP loads a bit later, poll briefly
  if (!hookTCF()){
    var tries = 0, t = setInterval(function(){
      tries++;
      if (hookTCF() || tries > 40) clearInterval(t); // up to ~4s
    }, 100);
  }

  // Fallback for non-EEA visitors (no __tcfapi): keep using our local preference
  // Our existing local banner writes ttg.consent.v1 with {ads:true|false}.
  // If CMP absent, keep existing behavior (do not force-show anything here).

})();
</script>
<!-- === TTG CMP Consent Bridge END === -->

<!-- === TTG Cookie Consent END === -->
<script>
  try {
    var navs = Array.from(document.querySelectorAll('nav')).filter(function(node){
      return !node.closest('#global-nav');
    });
    if (navs.length > 0) console.warn('Duplicate navs detected on /gear:', navs.length);
  } catch(e){}
</script>
<!-- GLOBAL FOOTER v1.3.0 -->
<div id="site-footer"></div>
<script>
(async () => {
  try {
    const res = await fetch('/footer.v1.3.0.html?v=1.3.0', { cache: 'no-cache' });
    const html = await res.text();
    const host = document.getElementById('site-footer');
    if (host) host.outerHTML = html;
  } catch (e) { console.error('[Footer] load failed:', e); }
})();
</script>
<!-- === TTG Ad Slot View Tracking START === -->
<script src="/js/ad-slot-view-tracking.js"></script>
<!-- === TTG Ad Slot View Tracking END === -->
</body>
</html>
