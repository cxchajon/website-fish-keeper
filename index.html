<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Stocking Calculator</title>
<style>
  /* … keep all your existing styles … */
  :root { --gap: 12px; --radius: 12px; }
  *{ box-sizing: border-box; }
  body{ font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        margin:0; padding:24px; background:#f8fafc; color:#0f172a; }
  /* … existing CSS omitted for brevity … */

  .bar-wrap{ margin-top:8px; }
  .bar-labels{ display:flex; justify-content:space-between; font-size:0.9rem; color:#475569; margin-bottom:6px; }
  .bar{ position:relative; height:24px; border-radius:999px; overflow:hidden; background:#e2e8f0; }
  .bar-fill{ position:absolute; top:0; left:0; bottom:0; width:0%; background:linear-gradient(to right,#10b981,#f59e0b,#ef4444); transition: width .25s ease; }
</style>
</head>
<body>
  <!-- header and other sections remain unchanged -->

  <section class="card">
    <div class="row">
      <!-- tank size/filtration/planting fields remain here -->
    </div>

    <!-- existing bioload bar -->
    <div class="bar-wrap">
      <div class="bar-labels"><span>Low</span><span>High</span></div>
      <div class="bar" aria-live="polite">
        <div id="barFill" class="bar-fill"></div>
      </div>
    </div>

    <!-- NEW: aggression meter -->
    <div class="bar-wrap">
      <div class="bar-labels"><span>Peaceful</span><span>Aggressive</span></div>
      <div class="bar" aria-live="polite">
        <div id="aggBarFill" class="bar-fill"></div>
      </div>
    </div>
  </section>

  <!-- rest of your form and stock table sections remain unchanged -->

  <!-- Aggression warnings section unchanged -->
  <section class="card">
    <h2 style="margin-top:0">Aggression & Compatibility Warnings</h2>
    <div id="aggression-warnings"></div>
  </section>

<script>
/* existing species data and variables remain the same */

/* helper: compute aggression index (0 peaceful–100 conflict) based on issue severities */
function computeAggressionIndex(issues) {
  if (!issues || !issues.length) return 0;
  let index = 0;
  issues.forEach(issue => {
    if (issue.severity === 'danger') index = Math.max(index, 100);
    else if (issue.severity === 'warning') index = Math.max(index, 60);
    else if (issue.severity === 'caution') index = Math.max(index, 30);
  });
  return index;
}

/* update both bioload and aggression meters */
function updateMeters() {
  // bioload bar
  $("#barFill").style.width = pctUsed() + "%";
  // aggression bar
  const issues = checkAggressionIssues(stock);
  const index = computeAggressionIndex(issues);
  $("#aggBarFill").style.width = index + "%";
  // render warnings
  renderAggressionMessages(issues);
}

/* modify refreshAggression so it only calls updateMeters */
function refreshAggression() {
  updateMeters();
}

/* update all stock actions to call updateMeters instead of separate bar/warning calls */
function renderStock(){
  const tb = $("#tbody");
  tb.innerHTML = "";
  stock.forEach((it,i) => {
    const f = fishById(it.id);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${f ? f.name : "(unknown)"}</td>
      <td class="right">${it.qty}</td>
      <td class="right">
        <div class="controls">
          <button class="ghost" data-act="minus" data-i="${i}">–1</button>
          <button class="ghost" data-act="plus" data-i="${i}">+1</button>
          <button class="ghost" data-act="del" data-i="${i}">Delete</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll("button[data-act]").forEach(btn => {
    const i = Number(btn.dataset.i);
    const act = btn.dataset.act;
    btn.onclick = () => {
      if (act === "minus") stock[i].qty = Math.max(1, stock[i].qty - 1);
      if (act === "plus")  stock[i].qty = Math.max(1, stock[i].qty + 1);
      if (act === "del")   stock.splice(i,1);
      renderStock();
      updateMeters();
    };
  });
}

/* update other events to call updateMeters */
["#gallons","#filtration","#planted"].forEach(q => document.querySelector(q).addEventListener("input", () => {
  updateMeters();
}));
$("#addFish").addEventListener("click", () => {
  const id = $("#fishSelect").value;
  const qty = Math.max(1, Number($("#fQty").value||0));
  if (!id) return;
  if (!qty){ alert("Enter a quantity."); return; }
  stock.push({ id, qty });
  renderStock();
  updateMeters();
  $("#fQty").value = "";
});
$("#reset").addEventListener("click", () => {
  stock = [];
  renderStock();
  updateMeters();
});

/* init: call once at load */
applySearch();
renderStock();
updateMeters();
</script>
</body>
</html>