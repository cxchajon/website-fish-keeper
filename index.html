<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Stocking Calculator</title>
<style>
  :root { --gap: 12px; --radius: 12px; }
  *{ box-sizing: border-box; }
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    margin:0; padding:24px; background:#f8fafc; color:#0f172a;
  }
  header{ margin-bottom:16px; }
  h1{ font-size:1.35rem; margin:0 0 4px; }
  .card{
    background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.06);
    padding:16px; margin-bottom:16px;
  }
  .row{ display:flex; flex-wrap:wrap; gap:var(--gap); }
  .row > *{ flex:1 1 220px; }
  label{ display:block; font-weight:600; margin-bottom:6px; }
  input[type="number"], input[type="text"], select{
    width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff;
  }
  button{ padding:10px 14px; border:0; border-radius:10px; cursor:pointer; background:#2563eb; color:#fff; font-weight:600; }
  button.ghost{ background:#eef2ff; color:#1e293b; }
  .switch{ display:flex; align-items:center; gap:8px; }
  .switch input{ width:18px; height:18px; }

  /* Bars */
  .bars-wrap{ margin-top:8px; display:flex; flex-direction:column; gap:14px; }
  .bar-block h3{ margin:0 0 6px; font-size:1rem; color:#0f172a; }
  .bar{ position:relative; height:24px; border-radius:999px; overflow:hidden; background:#e2e8f0; }
  .bar-fill{ position:absolute; top:0; left:0; bottom:0; width:0%; background: linear-gradient(to right, #10b981, #f59e0b, #ef4444); transition: width .25s ease; }
  .bar-note{ display:flex; justify-content:space-between; font-size:0.9rem; color:#475569; margin-top:6px; }

  /* Helper notes with tooltip */
  small.note {
    color:#94a3b8;
    display:block;
    margin-top:4px;
    font-size:0.8rem;
    font-style:italic;
    position:relative;
    padding-left:22px;   /* space for icon */
    max-width:100%;
  }
  .note .info {
    position:absolute;
    left:0;
    top:0;
    line-height:1;
    cursor:pointer;
    user-select:none;
    font-style:normal;
  }
  .note .info:focus { outline:2px solid #94a3b8; outline-offset:2px; border-radius:4px; }

  /* Tooltip bubble (appears BELOW the note) */
  .note .tip {
    position:absolute;
    left:0;           /* align with note start */
    top:100%;         /* directly below note */
    margin-top:6px;
    background:#111827;   /* dark gray */
    color:#fff;
    font-size:0.75rem;
    padding:6px 10px;
    border-radius:6px;
    white-space:nowrap;
    box-shadow:0 4px 10px rgba(0,0,0,.18);
    opacity:0;
    pointer-events:none;
    transform:translateY(-4px);
    transition: opacity .15s ease, transform .15s ease;
    z-index:20;
  }
  /* Show on desktop hover */
  .note:hover .tip { opacity:1; pointer-events:auto; transform:translateY(0); }
  /* Show when toggled (mobile tap) */
  .note.show-tip .tip { opacity:1; pointer-events:auto; transform:translateY(0); }

  table{ width:100%; border-collapse:collapse; }
  th, td{ padding:10px; border-bottom:1px solid #e2e8f0; text-align:left; }
  .right{ text-align:right; }
  .controls{ display:flex; gap:6px; justify-content:flex-end; flex-wrap:wrap; }

  /* Aggression mini bar in table */
  .mini-bar { width:120px; height:10px; background:#e2e8f0; border-radius:999px; overflow:hidden; display:inline-block; vertical-align:middle; }
  .mini-fill { height:100%; width:0%; transition:width .25s ease; background:linear-gradient(90deg, #10b981, #f59e0b, #ef4444); }
  .mini-label { font-size:12px; color:#475569; margin-left:6px; vertical-align:middle; }

  @media (max-width: 540px){
    body{ padding:16px; }
    .row > *{ flex:1 1 100%; }
    /* Let long tooltips wrap on small screens */
    .note .tip { white-space:normal; max-width:calc(100vw - 64px); }
  }
</style>
</head>
<body>
<header>
  <h1>Stocking Calculator</h1>
</header>

<section class="card">
  <div class="row">
    <div>
      <label for="gallons">Tank size (US gallons)</label>
      <input id="gallons" type="number" min="1" value="20"/>
    </div>
    <div>
      <label for="filtration">Filtration</label>
      <select id="filtration">
        <option value="low">Low — Sponge filter (gentle flow)</option>
        <option value="standard" selected>Standard — Hang-on-back (≈4–10× turnover)</option>
        <option value="high">High — Sump/Canister (oversized)</option>
      </select>
    </div>
    <div>
      <label>Planted?</label>
      <div class="switch">
        <input id="planted" type="checkbox"/>
        <span>Yes</span>
      </div>
    </div>
  </div>

  <!-- Both meters with titles + tooltip notes -->
  <div class="bars-wrap">
    <div class="bar-block">
      <h3>Bioload</h3>
      <div class="bar" aria-live="polite"><div id="barFill" class="bar-fill"></div></div>
      <div class="bar-note"><span>Low</span><span>High</span></div>
      <small class="note">
        <span class="info" tabindex="0" role="button" aria-label="More info" aria-expanded="false">ℹ️</span>
        Bioload is an estimate. Filtration and plants adjust capacity.
        <span class="tip" role="tooltip">Estimated load. Adjusted by filtration and planting.</span>
      </small>
    </div>

    <div class="bar-block">
      <h3>Aggression Risk (Average conflicts)</h3>
      <div class="bar" aria-live="polite"><div id="aggBarFill" class="bar-fill"></div></div>
      <div class="bar-note"><span>Low</span><span>High</span></div>
      <small class="note">
        <span class="info" tabindex="0" role="button" aria-label="More info" aria-expanded="false">ℹ️</span>
        Serious conflicts automatically max this bar.
        <span class="tip" role="tooltip">Warnings (e.g., fin-nippers, Betta conflicts) will max this bar.</span>
      </small>
    </div>
  </div>
</section>

<section class="card">
  <h2 style="margin-top:0">Add Fish</h2>
  <div class="row">
    <div style="flex:1 1 320px">
      <label for="fishSearch">Search species</label>
      <input id="fishSearch" type="text" placeholder="Type to filter the list"/>
    </div>
  </div>
  <div class="row">
    <div style="flex:1 1 320px">
      <label for="fishSelect">Species</label>
      <select id="fishSelect"></select>
    </div>
  </div>
  <div class="row">
    <div style="flex:1 1 200px">
      <label for="recMin">Recommended minimum</label>
      <input id="recMin" type="number" value="" disabled/>
    </div>
  </div>
  <div class="row" style="align-items:flex-end">
    <div style="flex:1 1 200px">
      <label for="fQty">Quantity</label>
      <input id="fQty" type="number" min="1" placeholder=""/>
    </div>
    <div>
      <button id="addFish">Add</button>
    </div>
  </div>
</section>

<section class="card">
  <h2 style="margin-top:0">Current Stock</h2>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th class="right">Qty</th>
        <th class="right">Aggression</th>
        <th class="right">Actions</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  <div class="row" style="margin-top:8px">
    <div style="flex:1 1 200px"><button id="reset" class="ghost">Clear Stock</button></div>
  </div>
</section>

<section class="card">
  <h2 style="margin-top:0">Aggression & Compatibility Warnings</h2>
  <div id="aggression-warnings"></div>
</section>

<!-- Data + Logic + Glue -->
<script src="js/fish-data.js"></script>
<script src="js/aggression.js"></script>
<script src="js/stocking_advisor.js"></script>

<!-- Tooltip behavior: hover (CSS) + tap/click (JS) + outside/ESC to close -->
<script>
  (function(){
    function closeAllNotes(except) {
      document.querySelectorAll('small.note.show-tip').forEach(n => {
        if (n !== except) {
          n.classList.remove('show-tip');
          const btn = n.querySelector('.info');
          if (btn) btn.setAttribute('aria-expanded','false');
        }
      });
    }

    // Toggle on click/tap
    document.addEventListener('click', function(e){
      const info = e.target.closest('.note .info');
      const note = info ? info.closest('.note') : null;

      if (note) {
        // Toggle this one
        const isOpen = note.classList.toggle('show-tip');
        info.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        // Close others
        if (isOpen) closeAllNotes(note);
        e.stopPropagation();
        return;
      }
      // Clicked elsewhere — close all
      closeAllNotes();
    });

    // Keyboard support: Enter/Space toggles, Esc closes
    document.addEventListener('keydown', function(e){
      const active = document.activeElement;
      const isInfo = active && active.classList && active.classList.contains('info');

      if (isInfo && (e.key === 'Enter' || e.key === ' ')) {
        e.preventDefault();
        active.click();
      } else if (e.key === 'Escape') {
        closeAllNotes();
      }
    });
  })();
</script>
</body>
</html>