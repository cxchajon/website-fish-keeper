<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FishKeeper – Stocking Advisor (Aggression v2)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; background: #f7f7f7; }
    h1 { text-align: center; margin-bottom: 12px; }
    .card { background:#fff; border:1px solid #ddd; border-radius:8px; padding:12px; margin:12px auto; max-width:720px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
    .row > * { flex:1; min-width: 160px; }
    label { display:block; font-size:14px; margin-bottom:6px; color:#333; }
    input, select, button { width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; font-size:16px; }
    button { background:#0b84ff; color:#fff; border:none; cursor:pointer; }
    button:hover { opacity:0.95; }
    .list { display:flex; flex-direction:column; gap:10px; }
    .fish-item { border:1px solid #e3e3e3; border-radius:8px; padding:10px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .fish-meta { flex: 2; min-width: 220px; }
    .fish-actions { display:flex; gap:8px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#274;
            margin-left:6px; border:1px solid #cbd5ff; }
    .warn { font-size:12px; color:#b45309; margin-top:6px; }
    .danger { color:#b91c1c; }
  </style>
</head>
<body>
  <h1>Stocking Advisor – Aggression (Option 2)</h1>

  <!-- Controls -->
  <div class="card">
    <div class="row">
      <div>
        <label for="species">Species</label>
        <select id="species"></select>
      </div>
      <div>
        <label for="recommended">Recommended minimum (if schooling)</label>
        <input id="recommended" type="number" min="1" value="1" readonly />
      </div>
      <div>
        <label for="qty">Quantity</label>
        <input id="qty" type="number" min="1" value="1" />
      </div>
      <div>
        <button id="addBtn">Add fish</button>
      </div>
    </div>
    <small id="speciesNotes" style="display:block;margin-top:8px;color:#555;"></small>
  </div>

  <!-- Tank list -->
  <div class="card">
    <h2 style="margin-top:0;">Your Tank</h2>
    <div id="tankList" class="list"></div>
  </div>

  <script>
    /**********************
     * Species “database” *
     **********************/
    const SPECIES = [
      {
        id: "betta_male",
        name: "Betta (Male)",
        baseAggression: 70,
        tags: { longFin: true, territorialMale: true, aggressive: true },
        notes: "Long-finned, territorial males should generally be kept solo.",
        recommendedMin: 1
      },
      {
        id: "cardinal_tetra",
        name: "Cardinal Tetra",
        baseAggression: 20,
        tags: { peaceful: true, schooling: true, small: true },
        notes: "Peaceful schooling fish. Keep in a group.",
        recommendedMin: 6
      },
      {
        id: "angelfish",
        name: "Angelfish",
        baseAggression: 50,
        tags: { semiAggressive: true, predator: true, longFin: true },
        notes: "Can prey on small fish as they grow. Semi-aggressive.",
        recommendedMin: 1
      },
      {
        id: "guppy",
        name: "Guppy",
        baseAggression: 15,
        tags: { peaceful: true, longFin: true, small: true },
        notes: "Peaceful, small, long-finned livebearer.",
        recommendedMin: 3
      },
      {
        id: "dwarf_gourami",
        name: "Dwarf Gourami",
        baseAggression: 35,
        tags: { semiAggressive: true, longFin: true },
        notes: "Can be territorial. Long fins.",
        recommendedMin: 1
      },
      {
        id: "zebra_danio",
        name: "Zebra Danio",
        baseAggression: 25,
        tags: { finNipper: true, schooling: true },
        notes: "Active, can nip fins if understocked.",
        recommendedMin: 6
      }
    ];

    /********************
     * UI: dropdown init *
     ********************/
    const speciesSelect = document.getElementById("species");
    const recommendedInput = document.getElementById("recommended");
    const qtyInput = document.getElementById("qty");
    const addBtn = document.getElementById("addBtn");
    const speciesNotes = document.getElementById("speciesNotes");
    const tankListEl = document.getElementById("tankList");

    // Fill dropdown
    SPECIES.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = s.name;
      speciesSelect.appendChild(opt);
    });

    function updateRecommendedUI() {
      const s = SPECIES.find(x => x.id === speciesSelect.value);
      if (!s) return;
      recommendedInput.value = s.recommendedMin || 1;
      speciesNotes.textContent = s.notes || "";
    }

    speciesSelect.addEventListener("change", updateRecommendedUI);
    updateRecommendedUI();

    /******************
     * Tank structure *
     ******************/
    // Each entry: { id, name, baseAggression, tags, qty, recommendedMin }
    const tank = [];

    addBtn.addEventListener("click", () => {
      const s = SPECIES.find(x => x.id === speciesSelect.value);
      const qty = Math.max(1, Number(qtyInput.value || 1));

      // push as one entry (aggregate quantity)
      const existing = tank.find(t => t.id === s.id);
      if (existing) {
        existing.qty += qty;
      } else {
        tank.push({ ...s, qty });
      }
      renderTank();
    });

    /***********************
     * Aggression Option 2 *
     ***********************/
    function getAggression(base, conflict) {
      const conflictBoosted = Math.min(100, conflict + 10);
      return Math.max(base, conflictBoosted);
    }

    /*********************
     * Conflict heuristics
     * (simple, explainable rules)
     *********************/
    function computeConflictForEntry(entry, allEntries) {
      let conflict = 0;
      const warnings = [];

      // 1) Multiple territorial male Bettas together
      if (entry.tags.territorialMale && entry.qty > 1) {
        conflict = Math.max(conflict, 90);
        warnings.push("Multiple territorial males together.");
      }

      // 2) Fin-nippers vs long-fin fish (conflict on the long-fin fish)
      const anyFinNipper = allEntries.some(e => e.tags.finNipper && e.qty > 0);
      if (entry.tags.longFin && anyFinNipper) {
        conflict = Math.max(conflict, 70);
        warnings.push("Long fins with fin-nippers.");
      }

      // 3) Peaceful fish kept with aggressive / semi-aggressive fish
      const anyAggressive = allEntries.some(e => (e.tags.aggressive || e.tags.semiAggressive) && e.qty > 0);
      if (entry.tags.peaceful && anyAggressive) {
        conflict = Math.max(conflict, 60);
        warnings.push("Peaceful fish with aggressive tankmates.");
      }

      // 4) Predator with small fish (conflict on the small fish)
      const anyPredator = allEntries.some(e => e.tags.predator && e.qty > 0);
      if (entry.tags.small && anyPredator) {
        conflict = Math.max(conflict, 80);
        warnings.push("Predator present with small fish.");
      }

      // 5) Schooling fish below recommended minimum (conflict on the schooling species)
      if (entry.tags.schooling && entry.qty < (entry.recommendedMin || 6)) {
        conflict = Math.max(conflict, 40);
        warnings.push(`Schooling understocked (have ${entry.qty}, recommend ${entry.recommendedMin || 6}).`);
      }

      return { conflict, warnings };
    }

    /****************
     * Render logic *
     ****************/
    function renderAggressionBar(container, base, conflict, label = "Aggression") {
      const value = getAggression(base, conflict);

      container.innerHTML = "";
      const wrap = document.createElement("div");
      wrap.style.width = "100%";
      wrap.style.margin = "6px 0";

      const lab = document.createElement("label");
      lab.style.display = "block";
      lab.style.marginBottom = "4px";
      lab.textContent = `${label}: ${value}%`;

      const track = document.createElement("div");
      track.style.width = "100%";
      track.style.height = "20px";
      track.style.background = "#e0e0e0";
      track.style.borderRadius = "4px";
      track.style.overflow = "hidden";

      const fill = document.createElement("div");
      fill.style.width = value + "%";
      fill.style.height = "100%";
      fill.style.transition = "width 0.3s ease-in-out";
      fill.style.background = value < 40 ? "green" : value < 70 ? "orange" : "red";

      track.appendChild(fill);
      wrap.appendChild(lab);
      wrap.appendChild(track);
      container.appendChild(wrap);

      return value;
    }

    function renderTank() {
      tankListEl.innerHTML = "";

      if (tank.length === 0) {
        const empty = document.createElement("div");
        empty.textContent = "No fish added yet.";
        empty.style.color = "#666";
        tankListEl.appendChild(empty);
        return;
      }

      tank.forEach((entry, idx) => {
        const item = document.createElement("div");
        item.className = "fish-item";

        const meta = document.createElement("div");
        meta.className = "fish-meta";
        const title = document.createElement("div");
        title.innerHTML = `<strong>${entry.name}</strong> <span class="pill">Qty: ${entry.qty}</span>`;
        meta.appendChild(title);

        const barHolder = document.createElement("div");
        const { conflict, warnings } = computeConflictForEntry(entry, tank);
        const agg = renderAggressionBar(barHolder, entry.baseAggression, conflict, "Aggression");

        if (warnings.length) {
          const warn = document.createElement("div");
          warn.className = "warn";
          warn.textContent = "Notes: " + warnings.join(" ");
          if (agg >= 80) warn.classList.add("danger");
          meta.appendChild(warn);
        }

        item.appendChild(meta);
        item.appendChild(barHolder);

        const actions = document.createElement("div");
        actions.className = "fish-actions";

        const removeBtn = document.createElement("button");
        removeBtn.textContent = "Remove one";
        removeBtn.style.background = "#ef4444";
        removeBtn.addEventListener("click", () => {
          entry.qty -= 1;
          if (entry.qty <= 0) {
            const i = tank.findIndex(t => t.id === entry.id);
            if (i >= 0) tank.splice(i, 1);
          }
          renderTank();
        });

        const addOneBtn = document.createElement("button");
        addOneBtn.textContent = "Add one";
        addOneBtn.style.background = "#10b981";
        addOneBtn.addEventListener("click", () => {
          entry.qty += 1;
          renderTank();
        });

        actions.appendChild(addOneBtn);
        actions.appendChild(removeBtn);
        item.appendChild(actions);

        tankListEl.appendChild(item);
      });
    }

    // Initial render (empty state)
    renderTank();
  </script>
</body>
</html>