<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FishKeeper – Stocking Advisor (Aggression Option 2)</title>
  <style>
    :root {
      --bg: #f7f7f7;
      --card: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --primary: #0b84ff;
      --danger: #ef4444;
      --success: #10b981;
    }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding:16px; }
    h1, h2 { margin:0 0 12px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:8px; padding:12px; margin:12px auto; max-width: 840px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
    .row > * { flex:1; min-width: 180px; }
    label { display:block; font-size:14px; margin-bottom:6px; color:#374151; }
    input, select, button {
      width:100%; padding:10px; border-radius:6px; border:1px solid #cbd5e1; font-size:16px; background:#fff; color:var(--text);
    }
    input[readonly] { background:#f3f4f6; color:#374151; }
    button { background:var(--primary); color:#fff; border:none; cursor:pointer; }
    button:hover { filter:brightness(0.98); }
    .btn-danger { background:var(--danger); }
    .btn-success { background:var(--success); }
    .list { display:flex; flex-direction:column; gap:10px; }
    .fish-item { border:1px solid var(--border); border-radius:8px; padding:12px; display:grid; grid-template-columns: 1fr; gap:10px; }
    @media (min-width: 700px) {
      .fish-item { grid-template-columns: 2fr 1fr auto; align-items:center; }
    }
    .fish-title { font-weight:600; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#1f2937; border:1px solid #c7d2fe; margin-left:8px; }
    .warn { font-size:12px; color:#b45309; margin-top:6px; }
    .danger { color:#b91c1c; }
    .muted { color:var(--muted); }
    .toolbar { display:flex; gap:8px; }
    .footer-note { text-align:center; font-size:12px; color:var(--muted); margin-top:8px; }
  </style>
</head>
<body>
  <h1 style="text-align:center;">Stocking Advisor – Aggression (Option 2)</h1>

  <!-- Controls -->
  <div class="card" id="controlsCard">
    <div class="row">
      <div>
        <label for="species">Species</label>
        <select id="species" aria-label="Species selector"></select>
      </div>
      <div>
        <label for="recommended">Recommended minimum (if schooling)</label>
        <input id="recommended" type="number" min="1" value="1" readonly />
      </div>
      <div>
        <label for="qty">Quantity</label>
        <input id="qty" type="number" min="1" value="1" />
      </div>
      <div>
        <button id="addBtn" title="Add fish to tank">Add fish</button>
      </div>
    </div>
    <small id="speciesNotes" class="muted" style="display:block;margin-top:8px;"></small>
  </div>

  <!-- Tank list -->
  <div class="card">
    <h2 style="margin-top:0;">Your Tank</h2>
    <div id="tankList" class="list"></div>
    <div class="toolbar" style="margin-top:10px;">
      <button id="clearBtn" class="btn-danger" title="Remove all fish">Clear tank</button>
    </div>
    <div class="footer-note">Aggression uses: <code>max(base, min(100, conflict + 10))</code> to lean toward conflicts.</div>
  </div>

  <script>
    /********************************
     * Species reference “database” *
     ********************************/
    const SPECIES = [
      {
        id: "betta_male",
        name: "Betta (Male)",
        baseAggression: 70,
        tags: { longFin: true, territorialMale: true, aggressive: true },
        notes: "Long-finned, territorial males should generally be kept solo.",
        recommendedMin: 1
      },
      {
        id: "cardinal_tetra",
        name: "Cardinal Tetra",
        baseAggression: 20,
        tags: { peaceful: true, schooling: true, small: true },
        notes: "Peaceful schooling fish. Keep in a group (6+ recommended).",
        recommendedMin: 6
      },
      {
        id: "angelfish",
        name: "Angelfish",
        baseAggression: 50,
        tags: { semiAggressive: true, predator: true, longFin: true },
        notes: "Can prey on small fish as they grow. Semi-aggressive.",
        recommendedMin: 1
      },
      {
        id: "guppy",
        name: "Guppy",
        baseAggression: 15,
        tags: { peaceful: true, longFin: true, small: true },
        notes: "Peaceful, small, long-finned livebearer.",
        recommendedMin: 3
      },
      {
        id: "dwarf_gourami",
        name: "Dwarf Gourami",
        baseAggression: 35,
        tags: { semiAggressive: true, longFin: true },
        notes: "Can be territorial. Long fins.",
        recommendedMin: 1
      },
      {
        id: "zebra_danio",
        name: "Zebra Danio",
        baseAggression: 25,
        tags: { finNipper: true, schooling: true },
        notes: "Active, can nip fins if understocked.",
        recommendedMin: 6
      }
    ];

    /********************
     * DOM references   *
     ********************/
    const speciesSelect = document.getElementById("species");
    const recommendedInput = document.getElementById("recommended");
    const qtyInput = document.getElementById("qty");
    const addBtn = document.getElementById("addBtn");
    const speciesNotes = document.getElementById("speciesNotes");
    const tankListEl = document.getElementById("tankList");
    const clearBtn = document.getElementById("clearBtn");

    /********************
     * Init dropdown    *
     ********************/
    function initSpeciesDropdown() {
      speciesSelect.innerHTML = "";
      SPECIES.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = s.name;
        speciesSelect.appendChild(opt);
      });
      updateRecommendedUI();
    }

    function updateRecommendedUI() {
      const s = SPECIES.find(x => x.id === speciesSelect.value);
      if (!s) return;
      recommendedInput.value = s.recommendedMin || 1;
      speciesNotes.textContent = s.notes || "";
    }

    speciesSelect.addEventListener("change", updateRecommendedUI);

    /******************
     * Tank structure *
     ******************/
    // Each entry: { id, name, baseAggression, tags, qty, recommendedMin }
    const tank = [];

    /*****************************
     * Aggression math (Option 2)
     *****************************/
    function getAggression(base, conflict) {
      // Option 2: conflicts +10, capped, then max with base
      const conflictBoosted = Math.min(100, (Number(conflict) || 0) + 10);
      return Math.max(Number(base) || 0, conflictBoosted);
    }

    /**********************
     * Conflict heuristics
     **********************/
    function computeConflictForEntry(entry, allEntries) {
      let conflict = 0;
      const warnings = [];

      const any = (pred) => allEntries.some(e => pred(e));
      const tag = (e, k) => !!(e.tags && e.tags[k]);

      // 1) Multiple territorial male Bettas together
      if (tag(entry, "territorialMale") && entry.qty > 1) {
        conflict = Math.max(conflict, 90);
        warnings.push("Multiple territorial males together.");
      }

      // 2) Fin-nippers vs long-fin fish (conflict on the long-fin fish)
      const anyFinNipper = any(e => tag(e, "finNipper") && e.qty > 0);
      if (tag(entry, "longFin") && anyFinNipper) {
        conflict = Math.max(conflict, 70);
        warnings.push("Long fins with fin-nippers.");
      }

      // 3) Peaceful fish with aggressive/semi-aggressive tankmates
      const anyAggressive = any(e => (tag(e, "aggressive") || tag(e, "semiAggressive")) && e.qty > 0);
      if (tag(entry, "peaceful") && anyAggressive) {
        conflict = Math.max(conflict, 60);
        warnings.push("Peaceful fish with aggressive tankmates.");
      }

      // 4) Predator with small fish (conflict on the small fish)
      const anyPredator = any(e => tag(e, "predator") && e.qty > 0);
      if (tag(entry, "small") && anyPredator) {
        conflict = Math.max(conflict, 80);
        warnings.push("Predator present with small fish.");
      }

      // 5) Schooling fish under recommended minimum (conflict on the schooling species)
      if (tag(entry, "schooling") && entry.qty < (entry.recommendedMin || 6)) {
        conflict = Math.max(conflict, 40);
        warnings.push(`Schooling understocked (have ${entry.qty}, recommend ${entry.recommendedMin || 6}).`);
      }

      return { conflict, warnings };
    }

    /****************
     * Render bar   *
     ****************/
    function renderAggressionBar(container, base, conflict, label = "Aggression") {
      const value = getAggression(base, conflict);

      container.innerHTML = "";
      const wrap = document.createElement("div");
      wrap.style.width = "100%";
      wrap.style.margin = "6px 0";

      const lab = document.createElement("label");
      lab.style.display = "block";
      lab.style.marginBottom = "4px";
      lab.textContent = `${label}: ${value}%`;

      const track = document.createElement("div");
      track.style.width = "100%";
      track.style.height = "20px";
      track.style.background = "#e0e0e0";
      track.style.borderRadius = "4px";
      track.style.overflow = "hidden";

      const fill = document.createElement("div");
      fill.style.width = value + "%";
      fill.style.height = "100%";
      fill.style.transition = "width 0.3s ease-in-out";
      fill.style.background = value < 40 ? "green" : value < 70 ? "orange" : "red";

      track.appendChild(fill);
      wrap.appendChild(lab);
      wrap.appendChild(track);
      container.appendChild(wrap);

      return value;
    }

    /****************
     * Render tank  *
     ****************/
    function renderTank() {
      tankListEl.innerHTML = "";

      if (tank.length === 0) {
        const empty = document.createElement("div");
        empty.textContent = "No fish added yet.";
        empty.className = "muted";
        tankListEl.appendChild(empty);
        return;
      }

      tank.forEach((entry) => {
        const item = document.createElement("div");
        item.className = "fish-item";

        // Left: meta
        const meta = document.createElement("div");
        const title = document.createElement("div");
        title.className = "fish-title";
        title.innerHTML = `${entry.name} <span class="pill">Qty: ${entry.qty}</span>`;
        meta.appendChild(title);

        // Middle: bar
        const barHolder = document.createElement("div");
        const { conflict, warnings } = computeConflictForEntry(entry, tank);
        const agg = renderAggressionBar(barHolder, entry.baseAggression, conflict, "Aggression");

        if (warnings.length) {
          const warn = document.createElement("div");
          warn.className = "warn";
          warn.textContent = "Notes: " + warnings.join(" ");
          if (agg >= 80) warn.classList.add("danger");
          meta.appendChild(warn);
        }

        // Right: actions
        const actions = document.createElement("div");
        actions.className = "toolbar";
        const addOneBtn = document.createElement("button");
        addOneBtn.textContent = "Add one";
        addOneBtn.className = "btn-success";
        addOneBtn.addEventListener("click", () => {
          entry.qty += 1;
          renderTank();
        });

        const removeOneBtn = document.createElement("button");
        removeOneBtn.textContent = "Remove one";
        removeOneBtn.className = "btn-danger";
        removeOneBtn.addEventListener("click", () => {
          entry.qty -= 1;
          if (entry.qty <= 0) {
            const i = tank.findIndex(t => t.id === entry.id);
            if (i >= 0) tank.splice(i, 1);
          }
          renderTank();
        });

        actions.appendChild(addOneBtn);
        actions.appendChild(removeOneBtn);

        item.appendChild(meta);
        item.appendChild(barHolder);
        item.appendChild(actions);
        tankListEl.appendChild(item);
      });
    }

    /****************
     * Add handlers *
     ****************/
    addBtn.addEventListener("click", () => {
      const s = SPECIES.find(x => x.id === speciesSelect.value);
      if (!s) return;
      const qty = Math.max(1, parseInt(qtyInput.value, 10) || 1);

      // Merge with existing entry if present
      const existing = tank.find(t => t.id === s.id);
      if (existing) {
        existing.qty += qty;
      } else {
        tank.push({ ...s, qty });
      }

      renderTank();
    });

    clearBtn.addEventListener("click", () => {
      tank.splice(0, tank.length);
      renderTank();
    });

    /***************
     * Boot        *
     ***************/
    window.addEventListener("DOMContentLoaded", () => {
      initSpeciesDropdown();
      renderTank();
    });
  </script>
</body>
</html>