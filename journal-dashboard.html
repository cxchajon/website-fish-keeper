<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KTRVCMQN');</script>
  <!-- End Google Tag Manager -->
  <link rel="preload" href="/footer.html?v=1.5.2" as="fetch" crossorigin="anonymous">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Tank Dashboard | The Tank Guide</title>
  <meta name="description" content="Real-time aquarium monitoring - water parameters, trends, and maintenance tracking">
  <link rel="canonical" href="https://thetankguide.com/journal-dashboard.html">

  <link rel="icon" type="image/png" href="/favicon.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" as="style">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" media="print" onload="this.media='all'">

  <link rel="stylesheet" href="/css/app.bundle.css?v=2025-11-07">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="/js/nav.js?v=1.1.0" defer></script>

  <style>
        /* ========================================
           DASHBOARD-SPECIFIC STYLES
           Scoped to not conflict with site CSS
           ======================================== */

        /* Dashboard wrapper - dark theme container */
        .dashboard-content {
            background: #0f172a;
            min-height: 80vh;
            padding: 2rem 0;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Dashboard-specific component styles */
        .dashboard-content .hero-metric {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 3px solid #2c7a7b;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
            box-shadow: 0 10px 30px rgba(44, 122, 123, 0.2);
        }

        .dashboard-content .hero-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #94a3b8;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .dashboard-content .hero-value {
            font-size: 5rem;
            font-weight: 800;
            color: #4299e1;
            line-height: 1;
            margin: 0.5rem 0;
        }

        .dashboard-content .hero-unit {
            font-size: 1.5rem;
            color: #94a3b8;
            margin-left: 0.5rem;
        }

        .dashboard-content .hero-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            font-size: 1rem;
            color: #e2e8f0;
        }

        .dashboard-content .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .dashboard-content .status-excellent { background: #38a169; }
        .dashboard-content .status-good { background: #38a169; }
        .dashboard-content .status-moderate { background: #d69e2e; }
        .dashboard-content .status-elevated { background: #f6ad55; }
        .dashboard-content .status-critical { background: #e53e3e; }

        .dashboard-content .hero-meta {
            color: #94a3b8;
            font-size: 0.95rem;
        }

        /* Metrics Bar */
        .dashboard-content .metrics-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .dashboard-content .metric-card {
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            transition: all 0.2s;
        }

        .dashboard-content .metric-card:hover {
            border-color: #2c7a7b;
            transform: translateY(-2px);
        }

        .dashboard-content .metric-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }

        .dashboard-content .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #e2e8f0;
            line-height: 1;
        }

        .dashboard-content .metric-subtext {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        .dashboard-content .metric-trend {
            font-size: 1.5rem;
            margin-top: 0.25rem;
        }

        /* Chart Section */
        .dashboard-content .chart-section {
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .dashboard-content .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .dashboard-content .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #4299e1;
        }

        .dashboard-content .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        /* Quick Stats */
        .dashboard-content .quick-stats {
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .dashboard-content .quick-stats h3 {
            font-size: 1.1rem;
            color: #4299e1;
            margin-bottom: 1rem;
        }

        .dashboard-content .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .dashboard-content .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #334155;
        }

        .dashboard-content .stat-label {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .dashboard-content .stat-value {
            color: #e2e8f0;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Loading & Error States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            text-align: center;
            color: #e2e8f0;
        }

        .spinner {
            border: 4px solid #334155;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .dashboard-content .error-banner {
            background: rgba(229, 62, 62, 0.15);
            border: 2px solid #e53e3e;
            border-radius: 8px;
            padding: 1rem;
            color: #fc8181;
            margin: 1rem 0;
            text-align: center;
        }

        .dashboard-content .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #94a3b8;
        }

        .dashboard-content .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Dashboard refresh button in nav (if adding to site nav) */
        .refresh-btn-nav {
            background: #2c7a7b;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .refresh-btn-nav:hover {
            background: #285e61;
        }

        .refresh-btn-nav:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .dashboard-content .hero-value {
                font-size: 3.5rem;
            }

            .dashboard-content .hero-unit {
                font-size: 1.2rem;
            }

            .dashboard-content .metrics-bar {
                grid-template-columns: 1fr;
            }

            .dashboard-content .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KTRVCMQN" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <a class="skip-link" href="#main-content">Skip to main content</a>
  <div id="site-nav"></div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
      <div class="loading-content">
          <div class="spinner"></div>
          <p>Loading tank data...</p>
      </div>
  </div>

  <!-- DASHBOARD CONTENT AREA (Dark Theme) -->
  <div class="dashboard-content" id="main-content">
      <div class="dashboard-container">

          <!-- Page Title -->
          <div style="text-align: center; margin: 2rem 0;">
              <h1 style="color: #4299e1; font-size: 2rem; margin: 0;">Aquarium Dashboard</h1>
              <p style="color: #94a3b8; margin: 0.5rem 0;">Real-time monitoring from a 29-gallon planted community tank</p>
              <div style="margin-top: 1rem;">
                <button id="refresh-btn" class="refresh-btn-nav">üîÑ Refresh Data</button>
              </div>
          </div>

          <!-- Hero Metric -->
          <div class="hero-metric">
              <div class="hero-label">Current Nitrate</div>
              <div class="hero-value">
                  <span id="hero-nitrate">--</span><span class="hero-unit">ppm</span>
              </div>
              <div class="hero-status">
                  <span class="status-dot" id="status-dot"></span>
                  <span id="status-text">Loading...</span>
                  <span class="hero-meta">‚Ä¢ Last test: <span id="hero-date">--</span></span>
              </div>
          </div>

          <!-- Metrics Bar -->
          <div class="metrics-bar">
              <div class="metric-card">
                  <div class="metric-label">Days Since WC</div>
                  <div class="metric-value" id="days-since">--</div>
                  <div class="metric-subtext" id="last-wc-date">--</div>
              </div>

              <div class="metric-card">
                  <div class="metric-label">Next Water Change</div>
                  <div class="metric-value" id="next-wc-days">--</div>
                  <div class="metric-subtext" id="next-wc-date">--</div>
              </div>

              <div class="metric-card">
                  <div class="metric-label">Trend</div>
                  <div class="metric-value metric-trend" id="trend-indicator">üìä</div>
                  <div class="metric-subtext" id="trend-text">Analyzing...</div>
              </div>

              <div class="metric-card">
                  <div class="metric-label">Total Readings</div>
                  <div class="metric-value" id="total-readings">--</div>
                  <div class="metric-subtext">Data points</div>
              </div>
          </div>

          <!-- Chart Section -->
          <div class="chart-section">
              <div class="section-header">
                  <h2 class="section-title">üìä 70-Day Nitrate History</h2>
              </div>
              <div class="chart-container">
                  <canvas id="nitrate-chart"></canvas>
              </div>
          </div>

          <!-- Quick Stats -->
          <div class="quick-stats">
              <h3>üìå Quick Stats</h3>
              <div class="stats-grid">
                  <div class="stat-item">
                      <span class="stat-label">Water changes</span>
                      <span class="stat-value" id="total-wc">--</span>
                  </div>
                  <div class="stat-item">
                      <span class="stat-label">Average nitrate</span>
                      <span class="stat-value" id="avg-nitrate">--</span>
                  </div>
                  <div class="stat-item">
                      <span class="stat-label">Data since</span>
                      <span class="stat-value" id="data-since">--</span>
                  </div>
                  <div class="stat-item">
                      <span class="stat-label">Last updated</span>
                      <span class="stat-value" id="last-updated">--</span>
                  </div>
              </div>
          </div>

          <!-- Error Banner -->
          <div id="error-banner" class="error-banner" style="display: none;"></div>

      </div>
  </div>

  <script src="/js/footer-loader.js?v=1.5.2" defer></script>
  <section class="legal-links" aria-label="Site legal links">
    <a href="/privacy-legal.html">Privacy Policy</a>
    <a href="/terms.html">Terms</a>
    <a href="/contact-feedback.html">Contact</a>
  </section>
  <noscript>
    <section class="legal-links" aria-label="Site legal links (noscript)">
      <a href="/privacy-legal.html">Privacy Policy</a>
      <a href="/terms.html">Terms</a>
      <a href="/contact-feedback.html">Contact</a>
    </section>
  </noscript>

  <div id="site-footer" data-footer-src="/footer.html?v=1.5.2"></div>

  <!-- KEEP THE EXISTING JAVASCRIPT FROM PREVIOUS PROMPT -->
  <script>
        /* ========================================
           COMMAND CENTER DASHBOARD
           ======================================== */

        // Ensure Chart.js is available
        if (typeof Chart === 'undefined') {
            throw new Error('Chart.js failed to load');
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        function parseDate(dateString) {
            return new Date(dateString);
        }

        function formatDate(date) {
            if (!(date instanceof Date)) {
                date = new Date(date);
            }
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function daysBetween(date1, date2) {
            const ONE_DAY = 1000 * 60 * 60 * 24;
            const diff = Math.abs(date2 - date1);
            return Math.floor(diff / ONE_DAY);
        }

        function getStatusClass(status) {
            switch(status) {
                case 'Excellent': return 'status-excellent';
                case 'Good': return 'status-good';
                case 'Moderate': return 'status-moderate';
                case 'Elevated': return 'status-elevated';
                default: return 'status-critical';
            }
        }

        // ============================================
        // DATA LOADER
        // ============================================

        class JournalDataLoader {
            constructor() {
                this.legacySources = [
                    '/data/journal.json',
                    '/data/reads.json',
                    '/data/journal-archive-sept2024.json',
                    '/data/journal-archive-aug2024.json',
                    '/data/journal-archive-jul2024.json'
                ];
                this.allReadings = [];
            }

            async loadMonthlyFiles() {
                console.log('üìÖ Loading monthly files...');
                try {
                    const response = await fetch('/data/journal/index.json');
                    if (!response.ok) {
                        console.warn('‚ö†Ô∏è Could not load monthly index');
                        return;
                    }
                    const months = await response.json();
                    console.log(`   Found ${months.length} monthly files`);

                    for (const month of months) {
                        await this.loadMonthFile(month);
                    }
                } catch (e) {
                    console.error('‚ùå Error loading monthly files:', e);
                }
            }

            async loadMonthFile(month) {
                const url = `/data/journal/${month}.json`;
                console.log(`üìÜ Loading ${url}...`);

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Failed to load ${url}`);
                    }

                    const entries = await response.json();
                    let addedCount = 0;

                    for (const entry of entries) {
                        const testDate = entry.date;
                        if (!testDate || isNaN(new Date(testDate))) continue;

                        // Check for nitrate_ppm field
                        let ppm = null;
                        if (entry.nitrate_ppm) {
                            // Handle ranges like "5-10" by taking first number
                            const ppmStr = String(entry.nitrate_ppm);
                            const match = ppmStr.match(/^(\d+)/);
                            if (match) {
                                ppm = parseFloat(match[1]);
                            }
                        }

                        // Check body text for nitrate patterns
                        if (ppm === null && entry.body) {
                            const bodyLower = entry.body.toLowerCase();
                            const patterns = [
                                /nitrate[s]?\s+(?:tested|measured|reading|at|came in at|held steady around)\s+(?:at\s+)?(\d+)/i,
                                /(\d+)\s*(?:‚Äì|-)\s*\d+\s*ppm/i,
                                /nitrate[s]?\s+(\d+)\s*ppm/i
                            ];
                            for (const pattern of patterns) {
                                const match = entry.body.match(pattern);
                                if (match) {
                                    ppm = parseFloat(match[1]);
                                    break;
                                }
                            }
                        }

                        // Detect water changes
                        const isWaterChange = (entry.category && entry.category.includes('Maintenance')) ||
                            (entry.body && entry.body.toLowerCase().includes('water change'));

                        // Add reading if we found a nitrate value
                        if (ppm !== null && !isNaN(ppm)) {
                            const isDuplicate = this.allReadings.some(reading =>
                                reading.date === testDate && Math.abs(reading.ppm - ppm) < 0.01
                            );

                            if (!isDuplicate) {
                                this.allReadings.push({
                                    date: testDate,
                                    ppm,
                                    wc: isWaterChange,
                                    source: url
                                });
                                addedCount++;
                            }
                        } else if (isWaterChange) {
                            // Add water change entry without ppm if not already present
                            const isDuplicate = this.allReadings.some(reading =>
                                reading.date === testDate && reading.wc === true
                            );

                            if (!isDuplicate) {
                                this.allReadings.push({
                                    date: testDate,
                                    ppm: 0,
                                    wc: true,
                                    source: url
                                });
                                addedCount++;
                            }
                        }
                    }

                    console.log(`   ‚úÖ Added ${addedCount} readings from ${url}`);
                } catch (e) {
                    console.error(`‚ùå Error loading ${url}:`, e);
                }
            }

            async loadAllData() {
                console.log('üöÄ Starting data load...');

                // Load monthly files first (newest data)
                await this.loadMonthlyFiles();

                // Then load legacy sources
                for (const source of this.legacySources) {
                    await this.loadFile(source);
                }

                console.log('üìä Total readings loaded:', this.allReadings.length);

                // Sort by date ascending
                this.allReadings.sort((a, b) => new Date(a.date) - new Date(b.date));

                return {
                    readings: this.allReadings,
                    current: this.getCurrentValues(),
                    stats: this.getStats()
                };
            }

            getCurrentValues() {
                const latest = [...this.allReadings].reverse().find((reading) =>
                    typeof reading.ppm === 'number' && !Number.isNaN(reading.ppm)
                );

                if (!latest) {
                    return {
                        nitrate: '--',
                        date: '--',
                        status: 'Unknown'
                    };
                }

                return {
                    nitrate: latest.ppm,
                    date: latest.date,
                    status: this.getStatus(latest.ppm)
                };
            }

            getStats() {
                return {
                    totalReadings: this.allReadings.length
                };
            }

            async loadFile(url) {
                console.log(`üó∫Ô∏è Loading ${url}...`);

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Failed to load ${url}`);
                    }

                    const data = await response.json();
                    console.log(`   ‚úÖ Loaded ${url}`);

                    let addedCount = 0;

                    // Determine format and process accordingly
                    if (Array.isArray(data)) {
                        // Newer format: array of entries
                        data.forEach(entry => {
                            if (entry.category === 'Parameters') {
                                const nitrateEntry = entry.parameters?.find(p => p?.name === 'Nitrate');
                                if (nitrateEntry?.value != null) {
                                    const testDate = entry.date || entry.test_date;
                                    if (testDate && !isNaN(new Date(testDate))) {
                                        const ppm = parseFloat(String(nitrateEntry.value).replace(/ppm/i, '').trim());
                                        if (!isNaN(ppm)) {
                                            const isDuplicate = this.allReadings.some(reading =>
                                                reading.date === testDate && Math.abs(reading.ppm - ppm) < 0.01
                                            );

                                            if (!isDuplicate) {
                                                this.allReadings.push({
                                                    date: testDate,
                                                    ppm,
                                                    wc: entry.category === 'Maintenance',
                                                    source: url
                                                });
                                                addedCount++;
                                            }
                                        }
                                    }
                                }
                            }

                            // Maintenance entries with WC flag
                            if (entry.category === 'Maintenance' && entry.water_change === true) {
                                const testDate = entry.date || entry.test_date;
                                if (testDate && !isNaN(new Date(testDate))) {
                                    const isDuplicate = this.allReadings.some(reading =>
                                        reading.date === testDate && reading.wc === true
                                    );

                                    if (!isDuplicate) {
                                        this.allReadings.push({
                                            date: testDate,
                                            ppm: 0,
                                            wc: true,
                                            source: url
                                        });
                                        addedCount++;
                                    }
                                }
                            }
                        });

                        console.log(`    Added ${addedCount} readings from ${url}`);

                    } else if (Array.isArray(data.entries)) {
                        // Legacy format with entries array
                        data.entries.forEach(entry => {
                            if (entry.type === 'parameter' && Array.isArray(entry.parameters)) {
                                const nitrateEntry = entry.parameters.find(p => p.name?.toLowerCase().includes('nitrate'));
                                if (nitrateEntry) {
                                    const ppm = parseFloat(String(nitrateEntry.value).replace(/ppm/i, '').trim());
                                    const testDate = entry.date || entry.test_date;
                                    if (!isNaN(ppm) && testDate && !isNaN(new Date(testDate))) {
                                        const isDuplicate = this.allReadings.some(reading =>
                                            reading.date === testDate && Math.abs(reading.ppm - ppm) < 0.01
                                        );

                                        if (!isDuplicate) {
                                            this.allReadings.push({
                                                date: testDate,
                                                ppm,
                                                wc: entry.category === 'Maintenance',
                                                source: url
                                            });
                                            addedCount++;
                                        }
                                    }
                                }
                            }
                        });

                        console.log(`    Added ${addedCount} readings from ${url}`);

                    } else {
                        // Main journal.json format: has nitrate array
                        if (data.nitrate && Array.isArray(data.nitrate)) {
                            data.nitrate.forEach(r => {
                                const isDuplicate = this.allReadings.some(reading =>
                                    reading.date === r.date && Math.abs(reading.ppm - r.ppm) < 0.01
                                );

                                if (!isDuplicate) {
                                    this.allReadings.push({
                                        date: r.date,
                                        ppm: r.ppm,
                                        wc: r.wc,
                                        source: url
                                    });
                                    addedCount++;
                                }
                            });

                            console.log(`    Added ${addedCount} readings from ${url}`);
                        } else {
                            console.warn(`    ‚ö†Ô∏è ${url} has no nitrate array`);
                        }
                    }

                } catch (e) {
                    console.error(`  ‚ùå Error loading ${url}:`, e);
                }
            }

            getStatus(ppm) {
                if (ppm < 10) return 'Excellent';
                if (ppm < 20) return 'Good';
                if (ppm < 40) return 'Moderate';
                if (ppm < 80) return 'Elevated';
                return 'Critical';
            }
        }

        // ============================================
        // DASHBOARD CONTROLLER
        // ============================================

        async function updateDashboard() {
            console.log('üéØ updateDashboard() called');

            try {
                const loader = new JournalDataLoader();
                const data = await loader.loadAllData();

                console.log('üìä Data loaded successfully:', {
                    totalReadings: data.readings.length,
                    currentNitrate: data.current.nitrate,
                    currentDate: data.current.date,
                    status: data.current.status
                });

                if (data.readings.length === 0) {
                    throw new Error('No data found in JSON files');
                }

                // Update all sections
                console.log('üîÑ Updating hero metric...');
                updateHeroMetric(data.current);

                console.log('üîÑ Updating metrics bar...');
                updateMetricsBar(data.readings, data.current);

                console.log('üîÑ Updating chart...');
                updateChart(data.readings);

                console.log('üîÑ Updating quick stats...');
                updateQuickStats(data.readings);

                // Hide loading overlay
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    overlay.style.display = 'none';
                    console.log('‚úÖ Loading overlay hidden');
                }

                console.log('‚úÖ Dashboard update complete');

            } catch (error) {
                console.error('‚ùå Dashboard update failed:', error);
                showError(error.message);
            }
        }

        function updateHeroMetric(current) {
            console.log('  Updating hero metric with:', current);

            const nitrateEl = document.getElementById('hero-nitrate');
            const statusEl = document.getElementById('status-text');
            const dateEl = document.getElementById('hero-date');
            const dotEl = document.getElementById('status-dot');

            if (nitrateEl) {
                nitrateEl.textContent = current.nitrate;
                console.log('    ‚úì Hero nitrate set to:', current.nitrate);
            }

            if (statusEl) {
                statusEl.textContent = current.status;
                console.log('    ‚úì Status text set to:', current.status);
            }

            if (dateEl) {
                const formattedDate = new Date(current.date).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                dateEl.textContent = formattedDate;
                console.log('    ‚úì Date set to:', formattedDate);
            }

            if (dotEl) {
                dotEl.className = 'status-dot ' + getStatusClass(current.status);
                console.log('    ‚úì Status dot class set to:', dotEl.className);
            }
        }

        function updateMetricsBar(readings, current) {
            console.log('  Updating metrics bar...');

            const daysSinceEl = document.getElementById('days-since');
            const lastWcDateEl = document.getElementById('last-wc-date');
            const nextWcDaysEl = document.getElementById('next-wc-days');
            const nextWcDateEl = document.getElementById('next-wc-date');
            const trendIndicator = document.getElementById('trend-indicator');
            const trendText = document.getElementById('trend-text');
            const totalReadingsEl = document.getElementById('total-readings');

            // Days since water change (using WC flag)
            const lastWcEntry = [...readings].reverse().find(r => r.wc === true);
            if (lastWcEntry) {
                const days = daysBetween(new Date(lastWcEntry.date), new Date());
                if (daysSinceEl) {
                    daysSinceEl.textContent = days;
                    console.log('    ‚úì Days since WC:', days);
                }
                if (lastWcDateEl) {
                    lastWcDateEl.textContent = `Last WC: ${formatDate(lastWcEntry.date)}`;
                }

                // Next WC (every 7 days)
                const nextWcDate = new Date(lastWcEntry.date);
                nextWcDate.setDate(nextWcDate.getDate() + 7);
                const daysUntilNext = Math.max(0, daysBetween(new Date(), nextWcDate));
                if (nextWcDaysEl) {
                    nextWcDaysEl.textContent = daysUntilNext;
                }
                if (nextWcDateEl) {
                    nextWcDateEl.textContent = `Next WC: ${formatDate(nextWcDate)}`;
                }
            }

            // Trend analysis (last 5 readings)
            const recent = readings.slice(-5);
            if (recent.length >= 2) {
                const delta = recent[recent.length - 1].ppm - recent[0].ppm;
                const trend = delta > 2 ? '‚ÜóÔ∏è Rising' : delta < -2 ? '‚ÜòÔ∏è Falling' : '‚û°Ô∏è Stable';
                if (trendIndicator) {
                    trendIndicator.textContent = delta > 2 ? 'üìà' : delta < -2 ? 'üìâ' : 'üìä';
                    console.log('    ‚úì Trend indicator set:', trendIndicator.textContent);
                }
                if (trendText) {
                    trendText.textContent = `${trend} (${delta.toFixed(1)} ppm)`;
                }
            }

            if (totalReadingsEl) {
                totalReadingsEl.textContent = readings.length;
                console.log('    ‚úì Total readings:', readings.length);
            }
        }

        function updateChart(readings) {
            console.log('  Rendering chart with readings:', readings.length);

            const ctx = document.getElementById('nitrate-chart');
            if (!ctx) {
                console.error('Chart canvas not found');
                return;
            }

            // Destroy existing chart if present
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }

            const labels = readings.map(r => formatDate(r.date));
            const data = readings.map(r => r.ppm);

            // Calculate ideal range overlay (0-20ppm)
            const idealRange = readings.map(() => 20);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Nitrate (ppm)',
                            data,
                            borderColor: '#4299e1',
                            backgroundColor: 'rgba(66, 153, 225, 0.1)',
                            tension: 0.3,
                            borderWidth: 3,
                            pointRadius: 0
                        },
                        {
                            label: 'Target (0-20 ppm)',
                            data: idealRange,
                            borderColor: 'rgba(72, 187, 120, 0.6)',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e2e8f0'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} ppm`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.2)' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.2)' }
                        }
                    }
                }
            });
        }

        function updateQuickStats(readings) {
            console.log('  Updating quick stats...');

            const totalWcEl = document.getElementById('total-wc');
            const avgNitrateEl = document.getElementById('avg-nitrate');
            const dataSinceEl = document.getElementById('data-since');
            const lastUpdatedEl = document.getElementById('last-updated');

            const wcCount = readings.filter(r => r.wc === true).length;
            // Filter out zero ppm readings (water change markers) for average calculation
            const nonZeroReadings = readings.filter(r => r.ppm > 0);
            const avg = nonZeroReadings.reduce((sum, r) => sum + r.ppm, 0) / (nonZeroReadings.length || 1);

            if (totalWcEl) {
                totalWcEl.textContent = wcCount;
                console.log('    ‚úì Total WCs:', wcCount);
            }

            if (avgNitrateEl) {
                avgNitrateEl.textContent = `${avg.toFixed(1)} ppm`;
            }

            if (dataSinceEl && readings.length > 0) {
                dataSinceEl.textContent = formatDate(readings[0].date);
            }

            if (lastUpdatedEl && readings.length > 0) {
                const last = readings[readings.length - 1];
                lastUpdatedEl.textContent = formatDate(last.date);
            }
        }

        function showError(message) {
            console.error('  showError called:', message);
            const banner = document.getElementById('error-banner');
            if (banner) {
                banner.textContent = message;
                banner.style.display = 'block';
            }

            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ DOM ready, initializing dashboard...');

            // Kick off initial load
            updateDashboard();

            // Refresh button handler
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async () => {
                    console.log('üîÑ Manual refresh triggered');
                    refreshBtn.disabled = true;
                    refreshBtn.textContent = '‚è≥ Refreshing...';

                    try {
                        await updateDashboard();
                        refreshBtn.textContent = '‚úì Refreshed';
                        setTimeout(() => {
                            refreshBtn.textContent = 'üîÑ Refresh';
                            refreshBtn.disabled = false;
                        }, 1500);
                    } catch (error) {
                        refreshBtn.textContent = '‚ùå Error';
                        setTimeout(() => {
                            refreshBtn.textContent = 'üîÑ Refresh';
                            refreshBtn.disabled = false;
                        }, 1500);
                    }
                });
            }

            // Auto-refresh every 5 minutes
            setInterval(() => {
                console.log('‚è∞ Auto-refresh triggered');
                updateDashboard();
            }, 5 * 60 * 1000);
        });
  </script>
</body>
</html>
