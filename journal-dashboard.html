<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Aquarium Dashboard | The Tank Guide</title>
    <meta name="description" content="Real-time aquarium monitoring dashboard tracking water parameters, feeding, and maintenance data.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    
    <style>
        /* ========================================
           DASHBOARD STYLES
           ======================================== */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: #e2e8f0;
            min-height: 100vh;
            padding: 1rem;
        }
        
        .dashboard-header {
            background: rgba(44, 122, 123, 0.1);
            border: 2px solid #2c7a7b;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .dashboard-header h1 {
            font-size: 1.8rem;
            color: #4299e1;
        }
        
        .header-nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .back-link, .refresh-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .back-link {
            background: #2c7a7b;
            color: white;
        }
        
        .back-link:hover {
            background: #285e61;
        }
        
        .refresh-btn {
            background: #4299e1;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .refresh-btn:hover {
            background: #3182ce;
        }
        
        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Status Cards Grid */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .status-card {
            background: #2d3748;
            border: 2px solid #4a5568;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }
        
        .status-card h3 {
            font-size: 0.9rem;
            color: #a0aec0;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #4299e1;
            margin: 0.5rem 0;
        }
        
        .stat-unit {
            font-size: 0.9rem;
            color: #718096;
        }
        
        .stat-meta {
            font-size: 0.85rem;
            color: #a0aec0;
            margin-top: 0.5rem;
        }
        
        /* Status Colors */
        .status-good {
            color: #38a169 !important;
        }
        
        .status-warning {
            color: #d69e2e !important;
        }
        
        .status-elevated {
            color: #f6ad55 !important;
        }
        
        .status-critical {
            color: #e53e3e !important;
        }
        
        /* Chart Sections */
        .chart-section {
            background: #2d3748;
            border: 2px solid #4a5568;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .chart-section h2 {
            font-size: 1.5rem;
            color: #4299e1;
            margin-bottom: 1.5rem;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            border-radius: 12px;
            border: 2px dashed #4a5568;
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            color: #e2e8f0;
            font-size: 1.3rem;
            margin-bottom: 1rem;
        }
        
        .empty-state p {
            color: #a0aec0;
            line-height: 1.6;
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #a0aec0;
            font-style: italic;
        }
        
        /* Error State */
        .error-message {
            background: rgba(229, 62, 62, 0.1);
            border: 2px solid #e53e3e;
            border-radius: 8px;
            padding: 1rem;
            color: #fc8181;
            margin: 1rem 0;
        }
        
        /* Footer */
        .dashboard-footer {
            text-align: center;
            padding: 2rem;
            color: #718096;
            font-size: 0.9rem;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .dashboard-header h1 {
                font-size: 1.5rem;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>

    <!-- Dashboard Header -->
    <header class="dashboard-header">
        <h1>üê† Aquarium Dashboard</h1>
        <nav class="header-nav">
            <a href="/journal.html" class="back-link">‚Üê Back to Journal</a>
            <button id="refresh-dashboard" class="refresh-btn">üîÑ Refresh</button>
        </nav>
    </header>

    <!-- Status Cards Grid -->
    <div class="status-grid">
        
        <div class="status-card">
            <h3>Current Nitrate</h3>
            <div class="stat-value" id="current-nitrate">--</div>
            <div class="stat-unit">ppm</div>
            <div class="stat-meta">Last test: <span id="last-test-date">--</span></div>
        </div>
        
        <div class="status-card">
            <h3>Days Since WC</h3>
            <div class="stat-value" id="days-since-wc">--</div>
            <div class="stat-unit">days</div>
            <div class="stat-meta">Last: <span id="last-wc-date">--</span></div>
        </div>
        
        <div class="status-card">
            <h3>System Status</h3>
            <div class="stat-value" id="system-status">--</div>
            <div class="stat-meta" id="status-message">Analyzing...</div>
        </div>
        
        <div class="status-card">
            <h3>Total Readings</h3>
            <div class="stat-value" id="total-readings">--</div>
            <div class="stat-unit">recorded</div>
        </div>
        
    </div>

    <!-- Nitrate Chart -->
    <section class="chart-section">
        <h2>üìä Nitrate Levels Over Time</h2>
        <div class="chart-container">
            <canvas id="nitrate-chart" style="display: none;"></canvas>
            <div id="chart-empty-state" class="empty-state" style="display: none;">
                <div class="empty-icon">üìà</div>
                <h3>No Data Available</h3>
                <p>Chart will display once journal data loads.</p>
            </div>
            <div id="chart-loading" class="loading">
                Loading chart data...
            </div>
        </div>
    </section>

    <!-- Error Display -->
    <div id="dashboard-error" class="error-message" style="display: none;"></div>

    <!-- Footer -->
    <section class="dashboard-footer" aria-label="Dashboard footer">
        <p>Last updated: <span id="last-refresh">--</span></p>
        <p>Data source: Journal JSON files</p>
    </section>

    <script src="/js/footer-loader.js?v=1.5.2" defer></script>
    <div id="site-footer" data-footer-src="/footer.html?v=1.5.2"></div>

    <!-- Dashboard JavaScript -->
    <script>
        // ============================================
        // JOURNAL DATA LOADER
        // ============================================
        
        class JournalDataLoader {
            constructor() {
                this.allNitrateReadings = [];
                this.currentParameters = {
                    nitrate: null,
                    testDate: null,
                    tankHealth: 'Unknown'
                };
            }
            
            async loadAllData() {
                console.log('üîÑ Loading journal data from JSON files...');
                
                try {
                    // Try loading main journal.json
                    await this.loadMainJournal();
                    
                    // Try loading monthly files
                    await this.loadMonthlyData('2025-09');
                    await this.loadMonthlyData('2025-10');
                    await this.loadMonthlyData('2025-11');
                    
                    // Sort by date
                    this.allNitrateReadings.sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    // Set current parameters
                    this.setCurrentParameters();
                    
                    console.log(`‚úÖ Loaded ${this.allNitrateReadings.length} nitrate readings`);
                    
                    return {
                        nitrateReadings: this.allNitrateReadings,
                        currentParameters: this.currentParameters
                    };
                    
                } catch (error) {
                    console.error('‚ùå Error loading journal data:', error);
                    throw error;
                }
            }
            
            async loadMainJournal() {
                try {
                    const response = await fetch('/data/journal.json');
                    if (!response.ok) {
                        console.warn('‚ö†Ô∏è journal.json not found');
                        return;
                    }
                    
                    const data = await response.json();
                    
                    if (data.nitrate && Array.isArray(data.nitrate)) {
                        data.nitrate.forEach(reading => {
                            this.allNitrateReadings.push({
                                date: reading.date,
                                ppm: reading.ppm,
                                waterChange: reading.wc,
                                source: 'journal.json'
                            });
                        });
                    }
                    
                    console.log('‚úÖ Loaded journal.json');
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not load journal.json:', error.message);
                }
            }
            
            async loadMonthlyData(monthKey) {
                try {
                    const response = await fetch(`/data/journal/${monthKey}.json`);
                    if (!response.ok) {
                        console.warn(`‚ö†Ô∏è ${monthKey}.json not found`);
                        return;
                    }
                    
                    const entries = await response.json();
                    
                    if (!Array.isArray(entries)) {
                        console.warn(`‚ö†Ô∏è ${monthKey}.json is not an array`);
                        return;
                    }
                    
                    entries.forEach(entry => {
                        if (entry.nitrate_ppm && entry.nitrate_ppm !== "") {
                            const ppm = parseFloat(entry.nitrate_ppm);
                            if (!isNaN(ppm)) {
                                // Avoid duplicates
                                const exists = this.allNitrateReadings.some(r => 
                                    r.date === entry.date && r.ppm === ppm
                                );
                                
                                if (!exists) {
                                    this.allNitrateReadings.push({
                                        date: entry.date,
                                        ppm: ppm,
                                        waterChange: entry.category === 'Maintenance',
                                        title: entry.title,
                                        source: monthKey
                                    });
                                }
                            }
                        }
                    });
                    
                    console.log(`‚úÖ Loaded ${monthKey}.json (${entries.length} entries)`);
                    
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Could not load ${monthKey}.json:`, error.message);
                }
            }
            
            setCurrentParameters() {
                if (this.allNitrateReadings.length === 0) {
                    console.warn('‚ö†Ô∏è No nitrate readings found');
                    return;
                }
                
                const latest = this.allNitrateReadings[this.allNitrateReadings.length - 1];
                
                this.currentParameters.nitrate = latest.ppm;
                this.currentParameters.testDate = latest.date;
                
                // Determine health status
                if (latest.ppm < 10) {
                    this.currentParameters.tankHealth = 'Excellent';
                } else if (latest.ppm < 20) {
                    this.currentParameters.tankHealth = 'Good';
                } else if (latest.ppm < 40) {
                    this.currentParameters.tankHealth = 'Moderate';
                } else if (latest.ppm < 80) {
                    this.currentParameters.tankHealth = 'Elevated';
                } else {
                    this.currentParameters.tankHealth = 'Critical';
                }
                
                console.log('‚úÖ Current parameters set:', this.currentParameters);
            }
        }
        
        // ============================================
        // DASHBOARD UPDATE FUNCTIONS
        // ============================================
        
        async function updateDashboard() {
            console.log('üîÑ Starting dashboard update...');
            
            try {
                const loader = new JournalDataLoader();
                const data = await loader.loadAllData();
                
                if (data.nitrateReadings.length === 0) {
                    throw new Error('No nitrate data found in JSON files');
                }
                
                updateCurrentParameters(data.currentParameters);
                updateNitrateChart(data.nitrateReadings);
                updateStats(data.nitrateReadings);
                updateLastRefresh();
                
                console.log('‚úÖ Dashboard updated successfully');
                
            } catch (error) {
                console.error('‚ùå Dashboard update failed:', error);
                showErrorState(error.message);
            }
        }
        
        function updateCurrentParameters(params) {
            // Current nitrate
            const nitrateEl = document.getElementById('current-nitrate');
            if (nitrateEl && params.nitrate !== null) {
                nitrateEl.textContent = params.nitrate;
            }
            
            // Last test date
            const testDateEl = document.getElementById('last-test-date');
            if (testDateEl && params.testDate) {
                const date = new Date(params.testDate);
                testDateEl.textContent = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            }
            
            // Days since test
            if (params.testDate) {
                const daysSince = Math.floor((new Date() - new Date(params.testDate)) / (1000 * 60 * 60 * 24));
                const daysSinceEl = document.getElementById('days-since-wc');
                if (daysSinceEl) {
                    daysSinceEl.textContent = daysSince;
                }
                
                const lastWCDateEl = document.getElementById('last-wc-date');
                if (lastWCDateEl) {
                    lastWCDateEl.textContent = new Date(params.testDate).toLocaleDateString('en-US', {
                        month: 'long',
                        day: 'numeric'
                    });
                }
            }
            
            // System status
            updateSystemStatus(params);
        }
        
        function updateSystemStatus(params) {
            const statusEl = document.getElementById('system-status');
            const messageEl = document.getElementById('status-message');
            
            if (!statusEl || params.nitrate === null) return;
            
            // Remove all status classes
            statusEl.className = 'stat-value';
            
            let message, className;
            
            if (params.nitrate < 10) {
                message = 'Optimal nitrate levels';
                className = 'status-good';
            } else if (params.nitrate < 20) {
                message = 'Healthy nitrate range';
                className = 'status-good';
            } else if (params.nitrate < 40) {
                message = 'Water change due soon';
                className = 'status-warning';
            } else if (params.nitrate < 80) {
                message = 'Water change recommended';
                className = 'status-elevated';
            } else {
                message = 'Immediate water change needed';
                className = 'status-critical';
            }
            
            statusEl.textContent = params.tankHealth;
            statusEl.classList.add(className);
            
            if (messageEl) {
                messageEl.textContent = message;
            }
        }
        
        function updateStats(readings) {
            const totalReadingsEl = document.getElementById('total-readings');
            if (totalReadingsEl) {
                totalReadingsEl.textContent = readings.length;
            }
        }
        
        function updateNitrateChart(readings) {
            const canvas = document.getElementById('nitrate-chart');
            const emptyState = document.getElementById('chart-empty-state');
            const loadingState = document.getElementById('chart-loading');
            
            // Hide loading
            if (loadingState) loadingState.style.display = 'none';
            
            if (!readings || readings.length === 0) {
                if (canvas) canvas.style.display = 'none';
                if (emptyState) {
                    emptyState.style.display = 'block';
                    emptyState.querySelector('p').textContent = 'No nitrate readings found in JSON files.';
                }
                return;
            }
            
            // Show chart
            if (canvas) canvas.style.display = 'block';
            if (emptyState) emptyState.style.display = 'none';
            
            // Prepare chart data
            const labels = readings.map(r => {
                const date = new Date(r.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const dataPoints = readings.map(r => r.ppm);
            const pointColors = readings.map(r => r.waterChange ? '#38a169' : '#4299e1');
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (window.nitrateChart) {
                window.nitrateChart.destroy();
            }
            
            // Create new chart
            window.nitrateChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nitrate (ppm)',
                        data: dataPoints,
                        borderColor: '#4299e1',
                        backgroundColor: 'rgba(66, 153, 225, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointBackgroundColor: pointColors,
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e2e8f0'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 32, 44, 0.95)',
                            titleColor: '#e2e8f0',
                            bodyColor: '#cbd5e0',
                            callbacks: {
                                afterLabel: function(context) {
                                    const reading = readings[context.dataIndex];
                                    return reading.waterChange ? '(Water Change)' : '(Test Reading)';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nitrate (ppm)',
                                color: '#e2e8f0'
                            },
                            ticks: {
                                color: '#a0aec0'
                            },
                            grid: {
                                color: 'rgba(160, 174, 192, 0.15)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date',
                                color: '#e2e8f0'
                            },
                            ticks: {
                                color: '#a0aec0',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: 'rgba(160, 174, 192, 0.1)'
                            }
                        }
                    }
                }
            });
            
            console.log(`‚úÖ Chart rendered with ${readings.length} data points`);
        }
        
        function updateLastRefresh() {
            const refreshEl = document.getElementById('last-refresh');
            if (refreshEl) {
                refreshEl.textContent = new Date().toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            }
        }
        
        function showErrorState(message) {
            const errorEl = document.getElementById('dashboard-error');
            if (errorEl) {
                errorEl.style.display = 'block';
                errorEl.textContent = `‚ö†Ô∏è Error: ${message}. Check browser console for details.`;
            }
            
            // Hide loading states
            const loadingEl = document.getElementById('chart-loading');
            if (loadingEl) loadingEl.style.display = 'none';
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üê† Dashboard initializing...');
            
            // Initial load
            updateDashboard();
            
            // Auto-refresh every 5 minutes
            setInterval(updateDashboard, 5 * 60 * 1000);
            
            // Manual refresh button
            const refreshBtn = document.getElementById('refresh-dashboard');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async () => {
                    refreshBtn.disabled = true;
                    refreshBtn.textContent = 'üîÑ Refreshing...';
                    
                    try {
                        await updateDashboard();
                        refreshBtn.textContent = '‚úì Refreshed';
                        setTimeout(() => {
                            refreshBtn.textContent = 'üîÑ Refresh';
                        }, 2000);
                    } catch (error) {
                        refreshBtn.textContent = '‚ùå Error';
                        setTimeout(() => {
                            refreshBtn.textContent = 'üîÑ Refresh';
                        }, 2000);
                    } finally {
                        refreshBtn.disabled = false;
                    }
                });
            }
        });
    </script>

</body>
</html>
